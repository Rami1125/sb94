<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח. סבן VIP</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2c5282; --primary-light: #3b82f6; --font-main: 'Rubik', sans-serif; }
        html, body { font-family: var(--font-main); }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .chat-bubble-user { background-color: var(--primary); color: white; }
        .chat-bubble-agent { background-color: #e2e8f0; color: #1a202c; }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div id="app" class="h-screen w-screen overflow-hidden"></div>
    <div id="modal-container" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 p-4"></div>
    <div id="toast" class="fixed top-5 right-5 z-[100] transform translate-x-full transition-transform duration-300"></div>

<script>
    // --- Application State ---
    const state = {
        isLoading: true,
        isLoggedIn: false,
        activeScreen: 'login', // 'login', 'dashboard', 'chat'
        userData: null,
        catalog: [],
        chatHistory: [],
        loginError: null,
    };

    // --- API Configuration ---
    // Updated API URL from the new deployment
    const API_URL = 'https://script.google.com/macros/s/AKfycbxHG8ZnWZwIURIu-NZLAgmdpm5ZZ4G4XX0izG9EsU8sTS02hBzwXQFHYe2qANTQvaS0/exec';

    // --- Core API Call Function ---
    async function apiCall(action, data = {}, method = 'POST') {
        const url = `${API_URL}?action=${action}`;
        const options = { method, redirect: 'follow', headers: { 'Content-Type': 'application/json' } };
        if (method === 'POST') options.body = JSON.stringify(data);

        try {
            const response = await fetch(url, options);
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || 'Network error');
            return result.data;
        } catch (error) {
            console.error('API Error:', { action, error });
            showToast(`שגיאת תקשורת: ${error.message}`, 'danger');
            throw error;
        }
    }

    // --- Main Render Function ---
    function render() {
        const appContainer = document.getElementById('app');
        if (state.isLoading) {
            appContainer.innerHTML = `<div class="flex h-full items-center justify-center"><i class="fas fa-spinner fa-spin text-4xl text-blue-800"></i></div>`;
            return;
        }

        switch (state.activeScreen) {
            case 'login':
                appContainer.innerHTML = renderLoginScreen();
                attachLoginListener();
                break;
            case 'dashboard':
                appContainer.innerHTML = renderDashboard();
                attachDashboardListeners();
                break;
        }
    }

    // --- Component Renderers ---
    function renderLoginScreen() {
        const errorHtml = state.loginError ? `<p class="text-red-600 text-sm text-center mt-3">${state.loginError}</p>` : '';
        return `
            <div class="h-full flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-800 to-blue-500">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-white">ח. סבן VIP</h1>
                    <p class="text-white text-opacity-80 mt-2">ניהול הזמנות חכם ללקוחות</p>
                </div>
                <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6">
                    <form id="login-form">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">מספר טלפון</label>
                        <input type="tel" id="phone" name="phone" required class="w-full px-3 py-2 border ${state.loginError ? 'border-red-500' : 'border-gray-300'} rounded-md" placeholder="05X-XXXXXXX">
                        ${errorHtml}
                        <button type="submit" class="w-full mt-4 bg-blue-800 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center">כניסה</button>
                    </form>
                </div>
            </div>`;
    }

    function renderDashboard() {
        const user = state.userData.user;
        const projects = state.userData.projects;
        const orders = state.userData.orders;
        return `
            <div class="h-full flex flex-col">
                <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 shrink-0">
                    <div class="flex items-center"><img src="${user['קישור לאווטאר'] || ''}" onerror="this.style.display='none'" class="w-10 h-10 rounded-full object-cover border-2 border-blue-700"><span class="font-semibold text-lg mr-3">${user['שם לקוח']}</span></div>
                    <button id="logout-btn" class="text-gray-600 hover:text-red-500"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </header>
                <main class="flex-grow p-4 overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">הפרויקטים שלי</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${projects.length > 0 ? projects.map(p => `<div class="bg-white rounded-lg shadow p-4"><p class="font-bold text-blue-800">${p['שם פרויקט']}</p><p class="text-sm text-gray-600">${p['כתובת'] || 'לא צוינה כתובת'}</p></div>`).join('') : '<p>לא נמצאו פרויקטים.</p>'}</div>
                    <h2 class="text-xl font-bold mt-6 mb-4">הזמנות אחרונות</h2>
                    <div class="space-y-3">${orders.length > 0 ? orders.map(o => `<div class="bg-white rounded-lg shadow p-4"><p class="font-semibold">הזמנה: ${o['מזהה הזמנה'].substring(0,12)}...</p><p>סוג: ${o['סוג הזמנה']}</p><span class="text-sm font-medium py-1 px-2 rounded-full ${o['סטטוס'] === 'ממתין לביצוע' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">${o['סטטוס']}</span></div>`).join('') : '<p>לא נמצאו הזמנות.</p>'}</div>
                </main>
                <div class="absolute bottom-6 left-6 flex flex-col space-y-3">
                     <button id="fab-chat" class="bg-green-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl"><i class="fas fa-comments"></i></button>
                    <button id="fab-new-order" class="bg-blue-800 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl"><i class="fas fa-plus"></i></button>
                </div>
            </div>`;
    }

    function renderOrderModal() {
        // This is a simplified version. A real one would have more steps.
        const projectsOptions = state.userData.projects.map(p => `<option value="${p['מזהה פרויקט']}">${p['שם פרויקט']}</option>`).join('');
        return `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                <h3 class="text-xl font-bold mb-4">הזמנה חדשה</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm">בחר פרויקט</label>
                        <select id="project-select" class="w-full mt-1 p-2 border rounded">${projectsOptions}</select>
                    </div>
                    <div>
                        <label class="block text-sm">סוג הזמנה</label>
                        <input id="order-type" type="text" class="w-full mt-1 p-2 border rounded" placeholder="לדוגמה: מכולה 8 קוב">
                    </div>
                    <div>
                        <label class="block text-sm">פעולה</label>
                        <input id="order-action" type="text" class="w-full mt-1 p-2 border rounded" placeholder="לדוגמה: הורדה">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                    <button id="cancel-order" class="px-4 py-2 bg-gray-200 rounded">ביטול</button>
                    <button id="submit-order" class="px-4 py-2 bg-blue-800 text-white rounded">שלח הזמנה</button>
                </div>
            </div>`;
    }

     function renderChatModal() {
        const historyHtml = state.chatHistory.map(msg => `
            <div class="flex ${msg['שולח'] === 'לקוח' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-xs md:max-w-md p-3 rounded-lg ${msg['שולח'] === 'לקוח' ? 'chat-bubble-user' : 'chat-bubble-agent'}">
                    <p>${msg['תוכן הודעה']}</p>
                </div>
            </div>`).join('');

        return `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg h-[70vh] flex flex-col p-4">
                <h3 class="text-xl font-bold mb-4 shrink-0">צ'אט עם המשרד</h3>
                <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 p-2 bg-gray-50">${historyHtml}</div>
                <div class="mt-4 shrink-0">
                    <form id="chat-form" class="flex space-x-2 space-x-reverse">
                        <input type="text" id="chat-message" class="flex-grow p-2 border rounded" placeholder="כתוב הודעה..." required>
                        <button type="submit" class="p-3 bg-blue-800 text-white rounded"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>`;
    }


    // --- Event Listeners ---
    function attachLoginListener() {
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> מתחבר...`;
            await login(document.getElementById('phone').value);
        });
    }

    function attachDashboardListeners() {
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('fab-new-order').addEventListener('click', showOrderModal);
        document.getElementById('fab-chat').addEventListener('click', showChatModal);
    }

    // --- Logic & Actions ---
    async function login(phone) {
        state.loginError = null;
        try {
            state.userData = await apiCall('getUserData', { phone });
            state.isLoggedIn = true;
            state.activeScreen = 'dashboard';
            localStorage.setItem('customerPhone', phone);
            showToast(`ברוך הבא, ${state.userData.user['שם לקוח']}`, 'success');
        } catch (error) {
            state.loginError = error.message;
        } finally {
            state.isLoading = false;
            render();
        }
    }

    function logout() {
        state.isLoggedIn = false;
        state.activeScreen = 'login';
        localStorage.removeItem('customerPhone');
        render();
    }
    
    function showOrderModal() {
        openModal(renderOrderModal());
        document.getElementById('cancel-order').addEventListener('click', closeModal);
        document.getElementById('submit-order').addEventListener('click', async () => {
            const order = {
                projectId: document.getElementById('project-select').value,
                type: document.getElementById('order-type').value,
                action: document.getElementById('order-action').value,
                items: [{ type: document.getElementById('order-type').value, action: document.getElementById('order-action').value, qty: 1 }]
            };
            showToast('שולח הזמנה...', 'info');
            closeModal();
            await apiCall('createOrder', { order, user: state.userData.user });
            showToast('הזמנה נשלחה בהצלחה!', 'success');
            // Refresh data
            const refreshedData = await apiCall('getUserData', { phone: state.userData.user['מספר טלפון'] });
            state.userData = refreshedData;
            render();
        });
    }

    async function showChatModal() {
        openModal(`<div class="flex h-full items-center justify-center"><i class="fas fa-spinner fa-spin text-4xl text-blue-800"></i></div>`);
        state.chatHistory = await apiCall('getChatHistory', { customerId: state.userData.user['מזהה לקוח'] });
        openModal(renderChatModal()); // Re-render with history
        const chatHistoryDiv = document.getElementById('chat-history');
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom

        document.getElementById('chat-form').addEventListener('submit', async e => {
            e.preventDefault();
            const input = document.getElementById('chat-message');
            const message = input.value;
            if(!message) return;
            input.value = '';
            await apiCall('sendMessage', { message, user: state.userData.user });
            // For instant feedback, add message locally before refetching
            state.chatHistory.push({ 'שולח': 'לקוח', 'תוכן הודעה': message });
            openModal(renderChatModal());
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        });
    }

    // --- Utilities ---
    function openModal(content) {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `<div class="modal-enter">${content}</div>`;
        modalContainer.style.display = 'flex';
        modalContainer.onclick = (e) => { if (e.target === modalContainer) closeModal(); };
    }

    function closeModal() {
        const modalContainer = document.getElementById('modal-container');
        const modalContent = modalContainer.firstChild;
        if(modalContent) modalContent.classList.replace('modal-enter', 'modal-leave');
        setTimeout(() => {
            modalContainer.style.display = 'none';
            modalContainer.innerHTML = '';
        }, 300);
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const colors = { success: 'bg-green-500', danger: 'bg-red-500', info: 'bg-blue-500' };
        toast.innerHTML = `<div class="py-2 px-4 rounded-lg shadow-lg text-white ${colors[type]}">${message}</div>`;
        toast.classList.remove('translate-x-full');
        setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }

    // --- Initialization ---
    async function init() {
        const savedPhone = localStorage.getItem('customerPhone');
        if (savedPhone) {
            await login(savedPhone);
        } else {
            state.isLoading = false;
            render();
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

