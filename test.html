<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח. סבן VIP</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f0f4f8;
            --bg-surface: #ffffff;
            --primary: #2c5282;
            --primary-light: #3b82f6;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --border-color: #e2e8f0;
            --danger: #e53e3e;
            --success: #38a169;
            --font-main: 'Rubik', sans-serif;
        }
        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-main);
        }
        .login-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-light); }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="h-full w-full">
        <!-- This is where the app will be rendered -->
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300">
        <p id="toast-message"></p>
    </div>

<script>
    // --- Application State ---
    const state = {
        isLoading: true,
        isLoggedIn: false,
        customerPhone: null,
        userData: null,
        catalog: [],
    };

    // --- API Configuration ---
    // This MUST be the deployment URL of your Google Apps Script Web App
    const API_URL = 'https://script.google.com/macros/s/AKfycbwVx10n61lVBHHp8Icsp-7oNUOiq2w5yL72Mg8ZdV8cZ5IcSyk1wB_4WmkLAwZUALY/exec';

    // --- Core API Communication Function ---
    /**
     * Handles all communication with the Google Apps Script backend.
     * @param {string} action - The action to perform (e.g., 'getUserData').
     * @param {object} data - The payload to send with the request.
     * @param {string} method - The HTTP method ('GET' or 'POST').
     * @returns {Promise<object>} - The JSON response from the server.
     */
    async function apiCall(action, data = {}, method = 'POST') {
        const url = `${API_URL}?action=${action}`; // Pass action in URL for flexibility
        
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            redirect: 'follow', // Important for Google Scripts
        };
        
        // Only add body for POST requests
        if (method === 'POST') {
             options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`שגיאת רשת: ${response.statusText}`);
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'שגיאה לא ידועה מהשרת');
            }
            return result;
        } catch (error) {
            console.error('API Call Error:', error);
            showToast(`שגיאת תקשורת: ${error.message}`, 'danger');
            throw error; // Re-throw the error to be caught by the calling function
        }
    }

    // --- UI Rendering ---

    /**
     * The main render function. It decides what to show based on the application state.
     */
    function renderApp() {
        const appContainer = document.getElementById('app');
        if (state.isLoading) {
            appContainer.innerHTML = renderLoading();
        } else if (!state.isLoggedIn) {
            appContainer.innerHTML = renderLoginScreen();
            attachLoginListener();
        } else {
            appContainer.innerHTML = renderMainDashboard();
            attachDashboardListeners();
        }
    }

    function renderLoading() {
        return `
            <div class="flex items-center justify-center h-full bg-white">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-800"></i>
                    <p class="mt-2 text-lg font-semibold text-gray-700">טוען נתונים...</p>
                </div>
            </div>`;
    }

    function renderLoginScreen() {
        return `
            <div class="login-bg h-full flex flex-col items-center justify-center p-4">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-white">ח. סבן VIP</h1>
                    <p class="text-white text-opacity-80 mt-2">ניהול הזמנות חכם ללקוחות</p>
                </div>
                <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6">
                    <form id="login-form">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">מספר טלפון</label>
                        <input type="tel" id="phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="05X-XXXXXXX">
                        <button type="submit" class="w-full mt-4 bg-blue-800 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                            כניסה
                        </button>
                    </form>
                </div>
            </div>`;
    }

    function renderMainDashboard() {
        const user = state.userData.user;
        const projects = state.userData.projects;
        const orders = state.userData.orders;

        return `
            <div class="h-full flex flex-col">
                <!-- Header -->
                <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                    <div class="flex items-center">
                        <img src="${user['קישור לאווטאר'] || ''}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-700">
                        <span class="font-semibold text-lg ml-3">${user['שם לקוח']}</span>
                    </div>
                    <button id="logout-btn" class="text-gray-600 hover:text-red-500">
                        <i class="fas fa-sign-out-alt fa-lg"></i>
                    </button>
                </header>

                <!-- Main Content -->
                <main class="flex-grow p-4 overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">הפרויקטים שלי</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${projects.map(p => `
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="font-bold text-blue-800">${p['שם פרויקט']}</p>
                                <p class="text-sm text-gray-600">${p['כתובת'] || 'לא צוינה כתובת'}</p>
                            </div>
                        `).join('')}
                    </div>

                    <h2 class="text-xl font-bold mt-6 mb-4">הזמנות אחרונות</h2>
                    <div class="space-y-3">
                        ${orders.map(o => `
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="font-semibold">הזמנה: ${o['מזהה הזמנה']}</p>
                                <p>סוג: ${o['סוג הזמנה']} - ${o['סוג פעולה']}</p>
                                <span class="text-sm font-medium py-1 px-2 rounded-full ${o['סטטוס'] === 'ממתין לביצוע' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                    ${o['סטטוס']}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </main>

                <!-- Floating Action Button -->
                <button id="fab-new-order" class="absolute bottom-6 left-6 bg-blue-800 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl">
                    <i class="fas fa-plus"></i>
                </button>
            </div>`;
    }

    // --- Event Listeners ---
    
    function attachLoginListener() {
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('phone').value;
            if (phone) {
                await login(phone);
            }
        });
    }

    function attachDashboardListeners() {
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', logout);

        // Add listener for new order button later
        // const fab = document.getElementById('fab-new-order');
        // fab.addEventListener('click', showNewOrderModal);
    }
    

    // --- Application Logic ---

    /**
     * Handles the login process.
     * @param {string} phone - The user's phone number.
     */
    async function login(phone) {
        state.isLoading = true;
        renderApp();

        try {
            const response = await apiCall('getUserData', { phone: phone }, 'POST');
            state.userData = response.data;
            state.isLoggedIn = true;
            state.customerPhone = phone;
            localStorage.setItem('customerPhone', phone); // Save phone for auto-login
            showToast(`ברוך הבא, ${state.userData.user['שם לקוח']}`, 'success');
        } catch (error) {
            state.isLoggedIn = false;
            // The error toast is already shown by apiCall
        } finally {
            state.isLoading = false;
            renderApp();
        }
    }
    
    function logout() {
        state.isLoggedIn = false;
        state.customerPhone = null;
        state.userData = null;
        localStorage.removeItem('customerPhone');
        showToast("התנתקת בהצלחה", "success");
        renderApp();
    }


    // --- Utility Functions ---

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        toast.classList.remove('bg-green-500', 'bg-red-500');
        if (type === 'danger') {
            toast.classList.add('bg-red-500');
        } else {
            toast.classList.add('bg-green-500');
        }
        
        toastMessage.textContent = message;
        toast.classList.remove('translate-x-full');

        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }
    

    // --- INITIALIZATION ---
    function init() {
        const savedPhone = localStorage.getItem('customerPhone');
        if (savedPhone) {
            login(savedPhone);
        } else {
            state.isLoading = false;
            renderApp();
        }
    }

    // Start the application once the DOM is fully loaded.
    document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
