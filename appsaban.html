/**
 * @fileoverview Google Apps Script for H. Saban VIP System Backend
 * @version 2.1 - Enhanced doPost to be more flexible, resolving 411 errors.
 * @author Gemini & User Collab
 */

// --- Global Configuration Settings ---
// This is the ID of your Google Sheet.
const SPREADSHEET_ID = '1c1HUdSgnd9ZzZ1NGg-dVXo_iKWCdF3rtZWIqFM9aYVg'; 

// These are the exact names of the sheets (tabs) in your Google Sheet file.
const SHEETS = {
    USERS: "לקוחות",
    ORDERS: "הזמנות",
    PROJECTS: "פרויקטים",
    CONTAINERS: "מעקב מכולות", // Corrected sheet name
    CATALOG: "קטלוג מוצרים"
    // Add other sheets here as needed
};

/**
 * Main entry point for all POST requests from the client application.
 * This function acts as a router, directing the request to the correct handler.
 */
function doPost(e) {
  // Basic validation to ensure the function is called correctly.
  if (!e || !e.postData || !e.postData.contents) {
    return createJsonResponse({ success: false, error: "Invalid request structure." });
  }

  try {
    const params = JSON.parse(e.postData.contents);
    
    // --- FIX [v2.1]: Make action handling flexible ---
    // Get action from the JSON body first, if it exists.
    // If not, get it from the URL parameter (e.g., ?action=getUserData).
    // This handles requests from both the app and other potential sources.
    const action = params.action || e.parameter.action; 
    
    if (!action) {
      return createJsonResponse({ success: false, error: "Action not specified in request." });
    }

    let result;

    Logger.log(`Action Received: "${action}", Parameters: ${JSON.stringify(params)}`);

    // Route the request to the appropriate function based on the 'action'.
    switch (action) {
      case 'getUserData':
        result = handleGetUserData(params);
        break;
      case 'createOrder':
        result = handleCreateOrder(params);
        break;
      case 'getCatalog':
        result = handleGetCatalog(params); // Pass params for consistency
        break;
      default:
        result = { success: false, error: 'Unknown action requested.' };
        break;
    }
    
    return createJsonResponse(result);

  } catch (err) {
    Logger.log(`ERROR: ${err.toString()} \nStack: ${err.stack}`);
    return createJsonResponse({ success: false, error: `A server error occurred: ${err.message}` });
  }
}

// --- Action Handler Functions ---

/**
 * Handles the 'getUserData' action. Finds a user by phone number and returns all their related data.
 * @param {object} params - The request parameters, containing the 'phone' number.
 * @returns {object} - A response object with success status and all user data, or an error.
 */
function handleGetUserData(params) {
    const { phone } = params;
    if (!phone) {
        return { success: false, error: "Phone number is required." };
    }

    const users = getData(SHEETS.USERS);
    // Find the user with the matching phone number.
    const user = users.find(u => u['מספר טלפון'] == phone);

    if (!user) {
        return { success: false, error: "מספר טלפון לא נמצא במערכת" };
    }
    
    const customerId = user['מזהה לקוח'];
    
    // Fetch all related data for this customer.
    const projects = getData(SHEETS.PROJECTS).filter(p => p['מזהה לקוח'] == customerId);
    // IMPORTANT: In the 'Orders' sheet, the column is 'מספר לקוח', not 'מזהה לקוח'.
    const orders = getData(SHEETS.ORDERS).filter(o => o['מספר לקוח'] == customerId);
    const containers = getData(SHEETS.CONTAINERS); // In a real app, you would filter this too.
    
    return {
        success: true,
        data: {
            user: user,
            projects: projects,
            orders: orders,
            containers: containers
        }
    };
}

/**
 * Handles the 'createOrder' action. Creates a new order in the 'Orders' sheet.
 * @param {object} params - The request parameters for the new order.
 * @returns {object} - A response object with success status and the new order ID.
 */
function handleCreateOrder(params) {
    const { phone, projectId, type, action, items } = params;

    // First, find the customer ID from the phone number.
    const users = getData(SHEETS.USERS);
    const user = users.find(u => u['מספר טלפון'] == phone);
    if (!user) {
        return { success: false, error: "Customer not found for this phone number." };
    }
    const customerId = user['מזהה לקוח'];

    const ordersSheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEETS.ORDERS);
    
    const newOrderId = `ORD-${Utilities.getUuid()}`;
    const now = new Date();

    // Create the new row to be added to the sheet.
    // The order of items in this array MUST match the order of columns in the 'הזמנות' sheet.
    const newRow = [
      newOrderId, // מזהה הזמנה
      customerId, // מספר לקוח
      projectId,  // פרויקט
      '', // כתובת Waze link (optional)
      type, // סוג הזמנה
      now, // קטגוריית סטטוס (using order date)
      action, // סוג פעולה
      now, // תאריך הזמנה
      'ממתין לביצוע', // סטטוס
      JSON.stringify(items), // פריטים (as a JSON string)
      '', // מס׳ מכולה (optional)
      0,  // משך שכירות בימים (optional)
      now, // created_at
      now, // updated_at
      user['שם לקוח'] // modified_by
    ];

    ordersSheet.appendRow(newRow);

    return {
        success: true,
        data: {
            orderId: newOrderId,
            status: 'ממתין לביצוע'
        }
    };
}


/**
 * Handles the 'getCatalog' action. Returns the entire product catalog.
 * @param {object} params - The request parameters (not used currently, but good practice).
 * @returns {object} - A response object with success status and the catalog data.
 */
function handleGetCatalog(params) {
    const catalogData = getData(SHEETS.CATALOG);
    return { success: true, data: catalogData };
}


// --- Utility Functions ---

/**
 * A generic function to get all data from a sheet and convert it to an array of objects.
 * This makes the data much easier to work with.
 * @param {string} sheetName - The name of the sheet to get data from.
 * @returns {Array<Object>} - An array of objects, where each object represents a row.
 */
function getData(sheetName) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(sheetName);
  if (!sheet) return [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  if (values.length < 2) return []; // No data beyond headers

  const headers = values[0];
  const data = [];

  for (let i = 1; i < values.length; i++) {
    let rowObject = {};
    for (let j = 0; j < headers.length; j++) {
      rowObject[headers[j]] = values[i][j];
    }
    data.push(rowObject);
  }
  return data;
}

/**
 * Creates a standardized JSON response object for the web app.
 * @param {object} obj - The JavaScript object to be returned as JSON.
 * @returns {ContentService.TextOutput} - The JSON response.
 */
function createJsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

