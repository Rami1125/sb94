<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>לוח בקרה - מעקב</title>
<style>
/* =============================================================================
   GEMINI-COMMAND (read this comment):
   - This file is the frontend UI.
   - The API_URL constant in the <script> tag below MUST be updated with
     the Apps Script Web App deployment URL.
   - Visual customizations can be made by changing the values in the :root
     CSS variables below (colors, radius, sizes).
   =============================================================================*/

/* :root - values for colors and sizes */
:root{
  --brand:#0b72b9;
  --accent:#ff9f1c;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #ffc107;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text: #333;
  --muted:#6b7280;
  --radius:10px;
  --shadow: 0 6px 18px rgba(10,25,47,0.08);
  --rtl: 1; /* Do not change */
}

/* --- Base & Layout --- */
*,*::before,*::after{ box-sizing:border-box; }
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  direction:rtl;
  text-align:right;
  background-color:var(--bg);
  color: var(--text);
  margin:0;
  padding: 20px;
  font-size: 16px;
  line-height:1.6;
}
.container{
  max-width:1600px;
  margin:0 auto;
  padding:0 15px;
}

/* --- Header & Title --- */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:25px;
  flex-wrap: wrap;
}
header h1{
  color: var(--brand);
  font-size:2.2rem;
  margin: 0;
}

/* --- KPI Cards --- */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
  gap:20px;
  margin-bottom:25px;
}
.kpi-card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border-left: 5px solid var(--brand);
}
.kpi-card h3{ margin:0 0 10px; font-size:1rem; color:var(--muted); }
.kpi-card .value{ font-size:2.5rem; font-weight:700; color:var(--brand); }
.kpi-card.overdue .value { color: var(--danger); }
.kpi-card.overdue { border-left-color: var(--danger); }
.kpi-card.closed-today .value { color: var(--success); }
.kpi-card.closed-today { border-left-color: var(--success); }

/* --- Controls & Toolbar --- */
.toolbar{
  display:flex;
  gap:15px;
  margin-bottom:20px;
  flex-wrap: wrap;
}
.search-box{
  flex-grow:1;
  position:relative;
}
#globalSearch{
  width:100%;
  padding:12px 15px 12px 40px;
  border:1px solid #ddd;
  border-radius:var(--radius);
  font-size:1rem;
}
.search-box::after{
  content:'🔍';
  position:absolute;
  left:15px;
  top:50%;
  transform:translateY(-50%);
  opacity:0.5;
}
.btn{
  padding:12px 20px;
  border-radius:var(--radius);
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:1rem;
  transition: all 0.2s;
}
.btn-primary{ background-color:var(--brand); color:white; }
.btn-primary:hover{ background-color: #0a619e; }
.btn-secondary{ background-color:var(--accent); color:white; }
.btn-secondary:hover{ background-color: #e68e0a; }

/* --- Table Styles --- */
.table-wrapper{
  overflow-x:auto;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:15px;
}
table{
  width:100%;
  border-collapse:collapse;
  white-space:nowrap;
}
th, td{
  padding:12px 15px;
  text-align:right;
  border-bottom:1px solid #eee;
}
th{
  background-color:#f8f9fa;
  font-weight:600;
  color:var(--muted);
  font-size:0.9rem;
  text-transform:uppercase;
}
tbody tr:hover{ background-color:#f4f7fb; }
.status{
  padding: 5px 10px;
  border-radius: 15px;
  font-weight: 600;
  font-size: 0.85rem;
  text-align: center;
  display: inline-block;
}
.status-open{ background-color: #ffc1072e; color: #b98b00; }
.status-closed{ background-color: #28a7452e; color: #1c7430; }
.status-overdue{ background-color: #dc35452e; color: #a71d2a; }
.actions-cell button{
  background:transparent;
  border:none;
  cursor:pointer;
  margin: 0 5px;
  font-size:1.2rem;
  opacity:0.7;
  transition: opacity 0.2s;
}
.actions-cell button:hover{ opacity:1; }

/* --- Modal --- */
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0; top:0;
  width:100%; height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
}
.modal-content{
  background-color:var(--card);
  margin:auto;
  padding:25px;
  border-radius:var(--radius);
  width:90%;
  max-width:600px;
  position:relative;
}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  padding-bottom:15px;
  margin-bottom:20px;
}
.modal-header h2{ margin:0; }
.close-button{
  font-size:2rem;
  font-weight:bold;
  cursor:pointer;
  line-height:1;
}
.modal-body .form-group{
  margin-bottom:15px;
}
.modal-body label{
  display:block;
  margin-bottom:5px;
  font-weight:600;
  color:var(--muted);
}
.modal-body input{
  width:100%;
  padding:10px;
  border:1px solid #ccc;
  border-radius:var(--radius);
}
.modal-footer{
  text-align:left;
  padding-top:15px;
  border-top:1px solid #eee;
  margin-top:20px;
}

/* --- Loader --- */
.loader-wrapper{
  text-align: center;
  padding: 50px;
}
.loader {
  border: 8px solid #f3f3f3;
  border-radius: 50%;
  border-top: 8px solid var(--brand);
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* --- Dev Notes Section --- */
.dev-notes-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 300px;
    background-color: white;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
    border-radius: var(--radius);
    overflow: hidden;
    z-index: 999;
}
.dev-notes-header {
    background-color: var(--muted);
    color: white;
    padding: 10px;
    font-weight: bold;
    cursor: pointer;
}
.dev-notes-content {
    padding: 15px;
    display: none; /* Initially hidden */
}
.dev-notes-content textarea {
    width: 100%;
    min-height: 100px;
    border: 1px solid #ddd;
    border-radius: var(--radius);
    padding: 8px;
    margin-bottom: 10px;
    resize: vertical;
}

</style>
</head>
<body>

<div class="container">
  <header>
    <h1>לוח בקרה למעקב</h1>
    <div class="dev-notes-container">
      <div class="dev-notes-header" onclick="toggleDevNotes()">הערות פיתוח</div>
      <div class="dev-notes-content">
        <textarea id="devNote" placeholder="הערות אחרונות..."></textarea>
        <button class="btn btn-primary" style="width:100%;" onclick="saveDevNote()">שמור הערה</button>
      </div>
    </div>
  </header>

  <div class="kpi-grid">
    <div class="kpi-card">
      <h3>סך הכל פתוחות</h3>
      <div class="value" id="kpi-open">0</div>
    </div>
    <div class="kpi-card overdue">
      <h3>באיחור (חריגה)</h3>
      <div class="value" id="kpi-overdue">0</div>
    </div>
    <div class="kpi-card closed-today">
      <h3>נסגרו היום</h3>
      <div class="value" id="kpi-closed-today">0</div>
    </div>
    <div class="kpi-card">
      <h3>סה"כ רשומות</h3>
      <div class="value" id="kpi-total">0</div>
    </div>
  </div>

  <div class="toolbar">
    <div class="search-box">
      <input type="text" id="globalSearch" placeholder="חיפוש כללי..." onkeyup="applyFilter()" />
    </div>
    <button class="btn btn-primary" onclick="openAddModal()">הוסף רשומה חדשה</button>
  </div>

  <div class="table-wrapper" id="table-container">
      <div class="loader-wrapper"><div class="loader"></div><p>טוען נתונים...</p></div>
  </div>

</div>


<!-- Edit/Add Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">עריכת רשומה</h2>
      <span class="close-button" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalForm">
      <!-- Form fields will be generated by JavaScript -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
      <button class="btn btn-primary" onclick="saveRow()">שמור שינויים</button>
    </div>
  </div>
</div>


<script>
// =========================================================================
// !!! IMPORTANT !!!
// REPLACE THE VALUE BELOW WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
// =========================================================================
const API_URL = "PASTE_YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE"; 
// =========================================================================


let rawData = [];
let headers = [];
let editRowIndex = null;

document.addEventListener("DOMContentLoaded", () => {
    if (API_URL === "PASTE_YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE") {
        document.getElementById('table-container').innerHTML = `<div style="text-align:center; padding: 40px; background-color:#fff3cd; border:1px solid #ffeeba; border-radius:var(--radius);">
            <h2>הגדרה נדרשת</h2>
            <p>עליך לעדכן את הקבוע <strong>API_URL</strong> בקובץ index.html עם כתובת ה-URL של ה-Web App שפרסת ב-Google Apps Script.</p>
        </div>`;
        return;
    }
    loadTableData();
    loadDevNotes();
});

/* --- API Communication --- */
async function apiRequest(method, params = {}) {
  const url = new URL(API_URL);
  let options = {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      redirect: 'follow',
  };
  
  if (method.toUpperCase() === 'POST') {
      options.method = 'POST';
      options.body = JSON.stringify(params);
      // This part is for CORS compatibility with Apps Script POST requests
      options.mode = 'no-cors'; 
      // Because of 'no-cors', we won't get a real response object, so we send a text/plain payload
      options.body = JSON.stringify(params);
      options.headers = {'Content-Type': 'text/plain;charset=utf-8'};
      
      // We perform the post, but then we will need to re-fetch data to see changes
      await fetch(url, options);
      // Return a simulated success as no-cors prevents reading the actual response
      return { status: "success", message: "POST request sent. Refreshing data." };

  } else { // GET
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      const response = await fetch(url, options);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
  }
}

/* --- Data Loading and Rendering --- */
async function loadTableData() {
    try {
        const response = await apiRequest('GET', { action: 'getData' });
        if (response && response.status === 'success') {
            rawData = response.data;
            headers = response.headers;
            renderTable(rawData);
            updateKPIs(rawData);
        } else {
            throw new Error(response.message || "Failed to load data.");
        }
    } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('table-container').innerHTML = `<p style="color:var(--danger);text-align:center;">שגיאה בטעינת הנתונים: ${error.message}</p>`;
    }
}

function renderTable(data) {
  const container = document.getElementById("table-container");
  if (!data || data.length === 0) {
    container.innerHTML = "<p>לא נמצאו נתונים.</p>";
    return;
  }

  let tableHtml = `<table><thead><tr>`;
  headers.forEach(h => { tableHtml += `<th>${h}</th>`; });
  tableHtml += `<th>פעולות</th></tr></thead><tbody>`;

  data.forEach(row => {
    tableHtml += `<tr data-row-index="${row.rowIndex}">`;
    headers.forEach(header => {
      let value = row[header] || "";
      if (header.toLowerCase().includes("תאריך")) {
          value = formatDate(value);
      }
      if (header === "סטטוס") {
          value = `<span class="status ${getStatusClass(row)}">${value}</span>`;
      }
      tableHtml += `<td>${value}</td>`;
    });
    // Actions cell
    tableHtml += `<td class="actions-cell">
        <button title="ערוך" onclick="openEditModal(${row.rowIndex})">✏️</button>
        <button title="שלח וואטסאפ" onclick="sendWhatsApp(${row.rowIndex})">💬</button>
        <button title="מחק" onclick="deleteRowPrompt(${row.rowIndex})">🗑️</button>
    </td>`;
    tableHtml += `</tr>`;
  });

  tableHtml += `</tbody></table>`;
  container.innerHTML = tableHtml;
}

/* --- KPIs --- */
function updateKPIs(data) {
    const today = new Date().toISOString().split('T')[0];
    const openStatus = data.filter(r => r['סטטוס']?.toLowerCase() === 'פתוח').length;
    const closedToday = data.filter(r => r['תאריך סגירה'] === today).length;
    
    // Find overdue items (status is open and expected end date is in the past)
    const overdue = data.filter(row => {
        const status = row['סטטוס'];
        const dueDateStr = row['תאריך סיום צפוי'];
        if (!dueDateStr || status?.toLowerCase() !== 'פתוח') return false;
        
        const dueDate = new Date(dueDateStr);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // Compare dates only
        return dueDate < todayDate;
    }).length;

    document.getElementById('kpi-open').innerText = openStatus;
    document.getElementById('kpi-overdue').innerText = overdue;
    document.getElementById('kpi-closed-today').innerText = closedToday;
    document.getElementById('kpi-total').innerText = data.length;
}


/* --- Modal & Editing --- */
function openAddModal() {
    editRowIndex = null;
    document.getElementById('modalTitle').innerText = 'הוספת רשומה חדשה';
    const formContainer = document.getElementById('modalForm');
    let formHtml = '';
    headers.forEach(header => {
        formHtml += `<div class="form-group">
            <label for="field-${header}">${header}</label>
            <input type="text" id="field-${header}" name="${header}">
        </div>`;
    });
    formContainer.innerHTML = formHtml;
    document.getElementById('editModal').style.display = 'flex';
}

function openEditModal(rowIndex) {
    const rowData = rawData.find(r => r.rowIndex === rowIndex);
    if (!rowData) {
      alert("Row not found!");
      return;
    }
    editRowIndex = rowIndex;
    document.getElementById('modalTitle').innerText = 'עריכת רשומה';
    const formContainer = document.getElementById('modalForm');
    let formHtml = '';
    headers.forEach(header => {
        formHtml += `<div class="form-group">
            <label for="field-${header}">${header}</label>
            <input type="text" id="field-${header}" name="${header}" value="${rowData[header] || ''}">
        </div>`;
    });
    formContainer.innerHTML = formHtml;
    document.getElementById('editModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

async function saveRow() {
    const form = document.getElementById('modalForm');
    const inputs = form.getElementsByTagName('input');
    const rowData = Array.from(inputs).map(input => input.value);
    
    let action;
    let params;

    if (editRowIndex) { // Update existing row
        action = 'updateRow';
        params = { action: action, rowIndex: editRowIndex, rowData: rowData };
    } else { // Add new row
        action = 'addRow';
        params = { action: action, rowData: rowData };
    }
    
    try {
        const response = await apiRequest('POST', params);
        // Because of no-cors, we don't get a meaningful response, so we just reload
        closeModal();
        loadTableData(); // Refresh data from the server
    } catch (error) {
        console.error(`Error saving row:`, error);
        alert(`Failed to save: ${error.message}`);
    }
}

async function deleteRowPrompt(rowIndex) {
    // Custom confirm dialog since native confirm() can be blocked.
    if (window.confirm('האם אתה בטוח שברצונך למחוק את הרשומה?')) {
        try {
            await apiRequest('POST', { action: 'deleteRow', rowIndex: rowIndex });
            loadTableData(); // Refresh data
        } catch (error) {
            console.error(`Error deleting row:`, error);
            alert(`Failed to delete: ${error.message}`);
        }
    }
}

/* --- Utilities --- */
function formatDate(dateString) {
    if (!dateString) return "";
    try {
        const date = new Date(dateString);
        // Use Israeli locale for dd/mm/yyyy format
        return date.toLocaleDateString('he-IL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (e) {
        return dateString; // Return original if invalid
    }
}

function getStatusClass(row) {
    const status = row['סטטוס']?.toLowerCase();
    if (status === 'סגור') return 'status-closed';

    const dueDateStr = row['תאריך סיום צפוי'];
    if (status === 'פתוח' && dueDateStr) {
        const dueDate = new Date(dueDateStr);
        const today = new Date();
        today.setHours(0,0,0,0);
        if (dueDate < today) {
            return 'status-overdue';
        }
    }
    return 'status-open';
}

function sendWhatsApp(rowIndex) {
  const row = rawData.find(r => r.rowIndex === rowIndex);
  if (!row) return;

  const phoneField = headers.find(h => h.toLowerCase().includes("טלפון"));
  const clientField = headers.find(h => h.toLowerCase().includes("לקוח"));
  
  const phone = phoneField ? row[phoneField] : "";
  const client = clientField ? row[clientField] : "לקוח";
  const text = encodeURIComponent(`שלום ${client}, בדיקת סטטוס הזמנה.`);
  if (!phone) { alert("אין שדה טלפון"); return; }
  window.open(`https://wa.me/${phone.replace(/[^0-9]/g,'')}?text=${text}`, "_blank");
}

/* Dev notes */
async function saveDevNote(){
  const text = document.getElementById("devNote").value.trim();
  if (!text) { alert("כתוב הערה"); return; }
  const note = { author: "Admin", text: text };
  try {
    await apiRequest('POST', { action: "saveDevNote", note: note });
    document.getElementById("devNote").value = "";
    loadDevNotes(); // Refresh notes
  } catch(e) {
    alert("Failed to save note.");
  }
}

async function loadDevNotes(){
  try {
    const resp = await apiRequest('GET', { action: "getDevNotes" });
    if (resp.status === "success" && resp.notes && resp.notes.length) {
      const latest = resp.notes.reverse().map(n => {
          const d = new Date(n.timestamp);
          const formattedDate = `${d.toLocaleDateString('he-IL')} ${d.toLocaleTimeString('he-IL')}`;
          return `${formattedDate} — ${n.author}: ${n.note}`;
      }).join("\n\n");
      document.getElementById("devNote").value = latest;
    }
  } catch(e) {
     console.error("Could not load dev notes", e);
  }
}

function toggleDevNotes() {
    const content = document.querySelector('.dev-notes-content');
    content.style.display = content.style.display === 'block' ? 'none' : 'block';
}


/* search filter */
function applyFilter(){
  const q = document.getElementById("globalSearch").value.trim().toLowerCase();
  if (!q) {
    renderTable(rawData);
    return;
  }
  const filteredData = rawData.filter(row => {
    return Object.values(row).some(val => 
      String(val).toLowerCase().includes(q)
    );
  });
  renderTable(filteredData);
}

// Close modal if clicked outside the content
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        closeModal();
    }
}
</script>

</body>
</html>
