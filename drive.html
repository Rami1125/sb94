<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מערכת CRM מתקדמת V3</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>


    <style>
        :root {
            --color-background: #F0F4F8; /* Lighter, cooler grey */
            --color-surface: #FFFFFF;
            --color-primary: #1E88E5; /* Professional Blue */
            --color-primary-light: #42A5F5;
            --color-secondary: #00ACC1; /* Cyan */
            --color-accent: #FFC107; /* Amber */
            --color-text-base: #263238; /* Darker Blue Grey */
            --color-text-muted: #546E7A;
            --color-border: #CFD8DC;
            --color-danger: #D32F2F;
            --color-warning: #FFA000;
            --color-success: #388E3C;
            --color-info: #0288D1;
            --font-main: 'Rubik', sans-serif;
        }

        body.dark {
            --color-background: #102A43;
            --color-surface: #243B53;
            --color-primary: #47B5FF;
            --color-primary-light: #6ACFFF;
            --color-secondary: #00D4EC;
            --color-accent: #FFD600;
            --color-text-base: #F0F4F8;
            --color-text-muted: #9FB3C8;
            --color-border: #334E68;
            --color-danger: #EF5350;
            --color-warning: #FFCA28;
            --color-success: #66BB6A;
            --color-info: #29B6F6;
        }
        
        /* General Styling */
        body { font-family: var(--font-main); background-color: var(--color-background); color: var(--color-text-base); transition: background-color 0.4s, color 0.4s; line-height: 1.6; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .btn-primary { background-color: var(--color-primary); color: white; background-image: linear-gradient(to right, var(--color-primary), var(--color-primary-light)); box-shadow: 0 6px 20px -5px color-mix(in srgb, var(--color-primary) 40%, transparent); }
        .btn-primary:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 30px -8px color-mix(in srgb, var(--color-primary) 60%, transparent); }
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text-base); border-color: var(--color-border); box-shadow: 0 4px 10px rgba(0,0,0,0.04); }
        .btn-secondary:hover { background-color: var(--color-background); border-color: var(--color-primary-light); color: var(--color-primary); transform: translateY(-2px); }
        .card { background-color: var(--color-surface); border-radius: 1rem; border: 1px solid var(--color-border); box-shadow: 0 6px 20px rgba(0,0,0,0.06); transition: all 0.4s; }
        .card:hover:not(.non-interactive) { transform: translateY(-6px); box-shadow: 0 12px 35px rgba(0,0,0,0.12); }
        .modal-overlay { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; padding: 1rem; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.4s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background-color: var(--color-surface); border-radius: 1.25rem; box-shadow: 0 15px 45px rgba(0,0,0,0.25); border: 1px solid var(--color-border); transform: scale(0.9); transition: transform 0.4s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        input, select, textarea { background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 0.7rem; transition: all 0.25s; padding: 0.75rem 1rem; width: 100%; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-primary) 25%, transparent); }
        
        /* Responsive Table */
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; border: 1px solid var(--color-border); margin-bottom: 0.5rem; border-radius: 0.75rem; padding: 0.75rem; }
            .responsive-table td { display: block; border: none; position: relative; padding-left: 50% !important; text-align: left; padding-top: 0.5rem; padding-bottom: 0.5rem; }
            .responsive-table td:before { content: attr(data-label); font-weight: 600; color: var(--color-text-muted); position: absolute; top: 50%; transform: translateY(-50%); left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: right; }
        }

    </style>
</head>
<body class="text-base">

    <!-- Global Placeholders: Loader, Alerts, Modals -->
    <div id="loader-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-[1000] opacity-0 pointer-events-none transition-opacity"><div class="w-20 h-20 border-8 border-t-8 border-gray-200 border-t-[var(--color-primary)] rounded-full animate-spin"></div></div>
    <div id="alert-container" class="fixed bottom-6 left-6 z-[1100] space-y-4"></div>
    <div id="notification-container" class="fixed top-6 right-6 z-[1200] space-y-3 w-80"></div>
    
    <!-- New Order Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="order-modal-title" class="text-2xl font-bold text-[var(--color-primary)]">יצירת הזמנה חדשה</h2>
                <button onclick="closeModal('order-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)]">&times;</button>
            </div>
            <form id="order-form" class="space-y-4 p-6 overflow-y-auto">
                <!-- Form content will be injected by JavaScript -->
            </form>
        </div>
    </div>


    <!-- Main CRM Application View -->
    <div id="crm-container">
        <header class="p-6 text-center border-b border-[var(--color-border)] bg-[var(--color-surface)] shadow-sm relative">
             <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-2"><img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" class="h-16 rounded-lg shadow-md border"><h1 class="text-3xl md:text-4xl font-bold text-[var(--color-primary)] mt-2 md:mt-0">מערכת CRM לניהול מכולות V3</h1></div>
            <p class="text-lg text-[var(--color-text-muted)] mb-4">ניהול מתקדם של לקוחות, משימות ונהגים</p>
            <div class="absolute top-5 left-5 flex gap-2">
                <button id="theme-toggle" class="text-2xl p-3 rounded-full hover:bg-[var(--color-border)]"><i class="fas fa-sun"></i></button>
            </div>
        </header>
        
        <nav class="flex justify-center p-4"><div class="card flex gap-3 p-3 shadow-lg flex-wrap justify-center">
            <button id="nav-orders" class="nav-tab-btn active" onclick="showPage('orders')"><i class="fas fa-receipt mr-2"></i>הזמנות</button>
            <button id="nav-tasks" class="nav-tab-btn" onclick="showPage('tasks')"><i class="fas fa-tasks mr-2"></i>ניהול משימות</button>
        </div></nav>

        <main class="flex-grow p-4 md:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <section id="orders-page" class="page-content space-y-8"></section>
            <section id="tasks-page" class="page-content hidden space-y-8"></section>
        </main>
    </div>
    
<script type="module">
    // --- GEMINI V3 UPGRADE ---
    // This version adds the full functionality for creating new orders.
    // 1. A new "Orders" page is the default view.
    // 2. A "New Order" button opens a modal form.
    // 3. The form submits data to the `doPost` function in Code.gs.
    // 4. The orders table refreshes automatically upon success.
    // --- END GEMINI V3 UPGRADE ---

    // --- CONFIGURATION & STATE ---
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzsF3kzAxfvtuSlZxmj6-Jn6diCj4OMzTsVO2tXPFx3c15x1fh9qjF_iknXxBeqz_of/exec'; // !!! החלף בכתובת ה-URL שקיבלת מ-Google Apps Script
    
    let allOrders = [];
    let allTasks = [];
    let allDrivers = [];
    let currentPage = 'orders';

    // --- UTILITY FUNCTIONS ---
    const getElem = (id) => document.getElementById(id);
    const openModal = (id) => getElem(id).classList.add('active');
    const closeModal = (id) => getElem(id).classList.remove('active');
    const showLoader = () => getElem('loader-overlay').classList.remove('opacity-0', 'pointer-events-none');
    const hideLoader = () => getElem('loader-overlay').classList.add('opacity-0', 'pointer-events-none');
    const formatDate = (dateInput) => dateInput ? new Date(dateInput).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
    const escapeHTML = (str) => String(str || '').replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));

    function showAlert(message, type = 'info', duration = 5000) {
        const container = getElem('alert-container');
        const alertItem = document.createElement('div');
        const themes = {
            success: { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-800', icon: 'fa-check-circle' },
            error: { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-800', icon: 'fa-times-circle' },
            info: { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-800', icon: 'fa-info-circle' }
        };
        const theme = themes[type] || themes.info;
        alertItem.className = `p-4 rounded-lg border-l-4 shadow-lg flex items-center gap-3 transform translate-x-full opacity-0 transition-all duration-500 ease-out ${theme.bg} ${theme.border} ${theme.text}`;
        alertItem.innerHTML = `<i class="fas ${theme.icon}"></i><p>${message}</p>`;
        container.prepend(alertItem);
        setTimeout(() => { alertItem.style.transform = 'translateX(0)'; alertItem.style.opacity = '1'; }, 100);
        setTimeout(() => { alertItem.style.transform = 'translateX(100%)'; alertItem.style.opacity = '0'; setTimeout(() => alertItem.remove(), 500); }, duration);
    }


    // --- API & DATA ---
    async function apiGet(action) {
        if (SCRIPT_WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
            showAlert('יש להגדיר את כתובת ה-API בקוד', 'error');
            throw new Error('API URL not configured');
        }
        const url = new URL(SCRIPT_WEB_APP_URL);
        url.searchParams.append('action', action);
        
        try {
            const response = await fetch(url, { method: 'GET', redirect: 'follow' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Server operation failed');
            return data.data;
        } catch (error) {
            showAlert(`שגיאת תקשורת: ${error.message}`, 'error');
            throw error;
        }
    }

    async function apiPost(action, payload) {
        if (SCRIPT_WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
            showAlert('יש להגדיר את כתובת ה-API בקוד', 'error');
            throw new Error('API URL not configured');
        }
        try {
            const response = await fetch(SCRIPT_WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Required for Apps Script doPost
                body: JSON.stringify({ action, payload })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Server operation failed');
            return data.data;
        } catch (error) {
            showAlert(`שגיאת תקשורת בשליחת נתונים: ${error.message}`, 'error');
            throw error;
        }
    }

    async function loadInitialData() {
        showLoader();
        try {
            [allOrders, allTasks, allDrivers] = await Promise.all([
                apiGet('listOrders'),
                apiGet('listTasks'),
                apiGet('listDrivers')
            ]);
            showPage(currentPage);
        } catch (error) {
            console.error("Failed to load initial data:", error);
            // Handle error display if needed
        } finally {
            hideLoader();
        }
    }
    
    // --- PAGE NAVIGATION & RENDERING (CRM) ---
    function showPage(pageId) {
        currentPage = pageId;
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.nav-tab-btn').forEach(b => b.classList.remove('active'));
        
        const pageContainer = getElem(`${pageId}-page`);
        pageContainer.innerHTML = '';
        pageContainer.classList.remove('hidden');
        getElem(`nav-${pageId}`).classList.add('active');
        
        const renderFunctions = {
            'orders': renderOrdersPage,
            'tasks': () => { pageContainer.innerHTML = '<h2>דף משימות (בבנייה)</h2>'; },
        };
        if (renderFunctions[pageId]) renderFunctions[pageId]();
    }
    
    // --- ORDERS PAGE ---
    function renderOrdersPage() {
        const page = getElem('orders-page');
        page.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-3xl font-bold">רשימת הזמנות</h2>
                <button class="btn btn-primary w-full sm:w-auto" onclick="openOrderModal()"><i class="fas fa-plus mr-2"></i>הזמנה חדשה</button>
            </div>
            <div id="orders-table-container" class="card p-4">
                <div class="overflow-x-auto rounded-lg border">
                    <table id="orders-table" class="w-full text-right table-auto responsive-table"></table>
                </div>
            </div>
        `;
        renderOrdersTable();
    }

    function renderOrdersTable() {
        const table = getElem('orders-table');
        if (!table) return;

        let tableHTML = `
            <thead>
                <tr class="bg-[var(--color-background)]">
                    <th class="p-3">תאריך</th>
                    <th class="p-3">לקוח</th>
                    <th class="p-3">פעולה</th>
                    <th class="p-3">סטטוס</th>
                    <th class="p-3">נהג</th>
                </tr>
            </thead>
            <tbody>`;

        if (allOrders.length === 0) {
            tableHTML += `<tr><td colspan="5" class="text-center p-8 text-gray-500">אין הזמנות להצגה. לחץ על "הזמנה חדשה" כדי להתחיל.</td></tr>`;
        } else {
            // Sort orders by date, newest first
            const sortedOrders = [...allOrders].sort((a, b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']));
            
            sortedOrders.forEach(order => {
                const driver = allDrivers.find(d => d.id == order['מזהה נהג משויך']);
                tableHTML += `
                    <tr class="border-t hover:bg-[var(--color-background)]">
                        <td class="p-3" data-label="תאריך">${formatDate(order['תאריך הזמנה'])}</td>
                        <td class="p-3 font-semibold" data-label="לקוח">${escapeHTML(order['שם לקוח'])}</td>
                        <td class="p-3" data-label="פעולה">${escapeHTML(order['סוג פעולה'])}</td>
                        <td class="p-3" data-label="סטטוס">${escapeHTML(order['סטטוס'])}</td>
                        <td class="p-3" data-label="נהג">${driver ? escapeHTML(driver.name) : 'לא שויך'}</td>
                    </tr>`;
            });
        }
        table.innerHTML = tableHTML + '</tbody>';
    }

    // --- NEW ORDER MODAL & LOGIC ---
    function openOrderModal() {
        const form = getElem('order-form');
        
        // Dynamic list of unique customer names for autocomplete suggestion
        const customerNames = [...new Set(allOrders.map(o => o['שם לקוח']))];

        form.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="order-customer-name" class="block text-sm mb-1">שם לקוח</label>
                    <input type="text" id="order-customer-name" name="שם לקוח" list="customer-list" required>
                    <datalist id="customer-list">
                        ${customerNames.map(name => `<option value="${escapeHTML(name)}"></option>`).join('')}
                    </datalist>
                </div>
                <div>
                    <label for="order-date" class="block text-sm mb-1">תאריך הזמנה</label>
                    <input type="date" id="order-date" name="תאריך הזמנה" required>
                </div>
                <div>
                    <label for="order-address" class="block text-sm mb-1">כתובת</label>
                    <input type="text" id="order-address" name="כתובת" required>
                </div>
                 <div>
                    <label for="order-phone" class="block text-sm mb-1">טלפון לקוח</label>
                    <input type="tel" id="order-phone" name="טלפון לקוח">
                </div>
                <div>
                    <label for="order-action-type" class="block text-sm mb-1">סוג פעולה</label>
                    <select id="order-action-type" name="סוג פעולה" required>
                        <option value="הורדה">הורדה</option>
                        <option value="החלפה">החלפה</option>
                        <option value="העלאה">העלאה</option>
                    </select>
                </div>
                 <div>
                    <label for="order-driver" class="block text-sm mb-1">שייך לנהג</label>
                    <select id="order-driver" name="מזהה נהג משויך" required>
                        <option value="">בחר נהג...</option>
                        ${allDrivers.map(driver => `<option value="${driver.id}">${escapeHTML(driver.name)}</option>`).join('')}
                    </select>
                </div>
            </div>
            <div class="border-t pt-4 mt-4 flex justify-end">
                <button type="submit" class="btn btn-primary">צור הזמנה</button>
            </div>
        `;
        
        // Set default date to today
        getElem('order-date').valueAsDate = new Date();

        form.onsubmit = handleOrderSubmit;
        openModal('order-modal');
    }

    async function handleOrderSubmit(event) {
        event.preventDefault();
        showLoader();
        
        const formData = new FormData(event.target);
        const newOrderData = Object.fromEntries(formData.entries());
        
        // Add default values required by the sheet
        newOrderData['תעודה'] = 'TEMP-' + Date.now(); // Temporary ID, sheet should generate a real one
        newOrderData['סטטוס'] = 'פתוח';
        // Add any other default fields here
        newOrderData['שם סוכן'] = '';
        newOrderData['מספר מכולה ירדה'] = '';
        newOrderData['מספר מכולה עלתה'] = '';


        try {
            const result = await apiPost('addOrder', newOrderData);
            showAlert('ההזמנה נוצרה בהצלחה!', 'success');
            closeModal('order-modal');
            // Refresh data to show the new order
            allOrders = await apiGet('listOrders');
            renderOrdersTable();
        } catch (error) {
            console.error("Failed to submit order:", error);
            // Error alert is already shown by apiPost
        } finally {
            hideLoader();
        }
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load data from Google Sheet on startup
        loadInitialData();
        
        getElem('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
        });
        
        // Expose globally required functions
        window.showPage = showPage;
        window.openOrderModal = openOrderModal;
        window.closeModal = closeModal;
    });
</script>

</body>
</html>
