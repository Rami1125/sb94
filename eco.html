<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM מכולות - גרסת מובייל</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-background: #E6F0E6;
            --color-surface: #FFFFFF;
            --color-primary: #2E8B57;
            --color-primary-light: #4CAF50;
            --color-text-base: #2F4F4F;
            --color-text-muted: #607D8B;
            --color-border: #CFD8DC;
            --color-danger: #D64545;
            --color-warning: #FFC107;
            --color-success: #4CAF50;
            --font-main: 'Rubik', sans-serif;
        }
        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body { 
            font-family: var(--font-main); 
            background-color: var(--color-background); 
            color: var(--color-text-base);
            display: flex;
            flex-direction: column;
        }
        
        /* Main Layout */
        #main-header {
            background-color: var(--color-surface);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        #page-content {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem 1rem 80px 1rem; /* Padding at bottom for nav bar */
        }

        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background-color: var(--color-surface);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--color-text-muted);
            transition: color 0.2s;
            flex-grow: 1;
            padding: 0.5rem 0;
        }
        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }
        .nav-item.active {
            color: var(--color-primary);
        }

        /* Floating Action Button (FAB) */
        #fab {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        /* Order Card Style */
        .order-card {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid var(--color-primary);
        }
        .order-card.status-חורג {
            border-left-color: var(--color-danger);
        }
        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .order-card-customer {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .status-badge {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            color: white;
        }
        .status-badge.bg-open { background-color: var(--color-success); }
        .status-badge.bg-overdue { background-color: var(--color-danger); }
        
        /* Bottom Sheet Modal */
        #bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
            pointer-events: none;
        }
        #bottom-sheet-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--color-surface);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            max-height: 90vh;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 2001;
            display: flex;
            flex-direction: column;
        }
        #bottom-sheet.active {
            transform: translateY(0);
        }
        #sheet-handle {
            width: 50px;
            height: 5px;
            background-color: var(--color-border);
            border-radius: 2.5px;
            margin: 0.5rem auto;
            cursor: grab;
        }
        #sheet-content {
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }
    </style>
</head>
<body>

    <header id="main-header" class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" class="h-10 rounded-md">
            <h1 class="text-xl font-bold text-[var(--color-primary)]">CRM נייד</h1>
        </div>
    </header>

    <main id="page-content">
        <!-- Page content will be rendered here by JS -->
    </main>

    <button id="fab" title="הוסף הזמנה חדשה">
        <i class="fas fa-plus"></i>
    </button>

    <nav id="bottom-nav">
        <button class="nav-item active" onclick="showPage('dashboard')">
            <i class="fas fa-home"></i>
            <span>ראשי</span>
        </button>
        <button class="nav-item" onclick="showPage('customers')">
            <i class="fas fa-users"></i>
            <span>לקוחות</span>
        </button>
        <button class="nav-item" onclick="showPage('reports')">
            <i class="fas fa-chart-line"></i>
            <span>דוחות</span>
        </button>
        <button class="nav-item" onclick="showPage('inventory')">
            <i class="fas fa-boxes-stacked"></i>
            <span>מלאי</span>
        </button>
    </nav>
    
    <div id="bottom-sheet-overlay" onclick="closeSheet()"></div>
    <div id="bottom-sheet">
        <div id="sheet-handle"></div>
        <div id="sheet-content">
            <!-- Sheet content will be rendered here by JS -->
        </div>
    </div>


<script>
    // --- CONFIGURATION & STATE---
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
    const OVERDUE_THRESHOLD_DAYS = 10;
    let allOrders = [];
    let currentPage = 'dashboard';
    
    // --- UTILITY FUNCTIONS ---
    const formatDate = (dateInput) => dateInput ? new Date(dateInput).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
    const escapeHTML = (str) => String(str).replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));

    // --- THEME ---
    function initializeTheme() {
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark');
            // This part of the code is intentionally left blank in this fix.
        }
        document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
    }
    function toggleTheme() {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        // This part of the code is intentionally left blank in this fix.
        showPage(currentPage);
    }

    // --- API & DATA ---
     async function fetchData() {
        const url = new URL(SCRIPT_WEB_APP_URL);
        url.searchParams.append('action', 'list');
        url.searchParams.append('status', 'all');
        try {
            const response = await fetch(url, { method: 'GET', redirect: 'follow' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
             if (!data.success) throw new Error(data.message || 'Server operation failed');
            return data.data;
        } catch (error) {
            console.error("Fetch Error:", error);
            document.getElementById('page-content').innerHTML = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">שגיאת רשת. בדוק את החיבור ונסה שוב.</div>`;
            return []; // Return empty array on error to prevent app crash
        }
    }

    async function loadOrders() {
        const rawOrders = await fetchData();
        allOrders = rawOrders.map(order => {
            const orderDate = new Date(order['תאריך הזמנה']);
            const daysPassed = Math.floor((new Date() - orderDate) / (1000 * 60 * 60 * 24));
            order._daysPassedCalculated = daysPassed;
            order._effectiveStatus = order['סטטוס'] === 'סגור' ? 'סגור' : (daysPassed >= OVERDUE_THRESHOLD_DAYS ? 'חורג' : 'פתוח');
            order.sheetRow = parseInt(order.sheetRow);
            return order;
        }).sort((a,b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']));
        showPage(currentPage);
    }

    // --- NAVIGATION ---
    function showPage(pageId) {
        currentPage = pageId;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.getAttribute('onclick').includes(`'${pageId}'`));
        });

        const renderFunctions = {
            'dashboard': renderDashboard,
            'customers': renderCustomersPage,
            'reports': renderReportsPage,
            'inventory': renderInventoryPage
        };
        
        const pageContainer = document.getElementById('page-content');
        pageContainer.scrollTop = 0; // Scroll to top on page change
        if (renderFunctions[pageId]) {
            pageContainer.innerHTML = renderFunctions[pageId]();
        } else {
            pageContainer.innerHTML = `<p>הדף "${pageId}" בבנייה.</p>`;
        }
    }
    
    // --- PAGES ---
    function renderDashboard() {
        const openOrders = allOrders.filter(o => o._effectiveStatus === 'פתוח').length;
        const overdueOrders = allOrders.filter(o => o._effectiveStatus === 'חורג').length;

        let html = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 rounded-lg text-center bg-green-100 text-green-800">
                    <p class="font-bold text-2xl">${openOrders}</p>
                    <p class="text-sm">הזמנות פתוחות</p>
                </div>
                 <div class="p-4 rounded-lg text-center bg-red-100 text-red-800">
                    <p class="font-bold text-2xl">${overdueOrders}</p>
                    <p class="text-sm">הזמנות חורגות</p>
                </div>
            </div>
            <h2 class="text-xl font-bold mb-4">הזמנות אחרונות</h2>
            <div id="orders-list">`;
        
        allOrders.slice(0, 20).forEach(order => { // Show latest 20 orders
            html += renderOrderCard(order);
        });

        html += `</div>`;
        return html;
    }

    function renderCustomersPage() {
        const customers = [...new Set(allOrders.map(o => o['שם לקוח']))].sort();
        let html = `<input type="search" id="customer-search" placeholder="חיפוש לקוח..." class="w-full mb-4 p-3 rounded-lg border">
                    <div id="customer-list-container">`;
        customers.forEach(customer => {
            const customerOrders = allOrders.filter(o => o['שם לקוח'] === customer);
            const openCount = customerOrders.filter(o => o._effectiveStatus !== 'סגור').length;
            html += `
                <div class="bg-white p-4 rounded-lg mb-2 flex justify-between items-center" data-customer-name="${escapeHTML(customer).toLowerCase()}">
                    <div>
                        <p class="font-bold">${escapeHTML(customer)}</p>
                        <p class="text-sm text-gray-500">${openCount} הזמנות פתוחות</p>
                    </div>
                    <button class="text-gray-400"><i class="fas fa-chevron-left"></i></button>
                </div>
            `;
        });
        html += `</div>`;

        // Add event listener after rendering
        setTimeout(() => {
            document.getElementById('customer-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#customer-list-container > div').forEach(div => {
                    div.style.display = div.dataset.customerName.includes(searchTerm) ? 'flex' : 'none';
                });
            });
        }, 0);
        
        return html;
    }
    
    function renderReportsPage() {
        return `<div class="text-center p-8 bg-white rounded-lg"><h2 class="text-xl font-bold">דוחות</h2><p class="text-gray-500 mt-2">דף הדוחות בגרסת המובייל נמצא בפיתוח.</p></div>`;
    }

    function renderInventoryPage() {
        return `<div class="text-center p-8 bg-white rounded-lg"><h2 class="text-xl font-bold">מלאי</h2><p class="text-gray-500 mt-2">דף המלאי בגרסת המובייל נמצא בפיתוח.</p></div>`;
    }

    // --- COMPONENTS ---
    function renderOrderCard(order) {
        const statusClass = order._effectiveStatus === 'חורג' ? 'status-חורג' : '';
        const badgeClass = order._effectiveStatus === 'חורג' ? 'bg-overdue' : 'bg-open';
        const badgeText = order._effectiveStatus === 'חורג' ? 'חורג' : 'פתוח';
        return `
            <div class="order-card ${statusClass}" onclick="openSheet(${order.sheetRow})">
                <div class="order-card-header">
                    <div>
                        <p class="order-card-customer">${escapeHTML(order['שם לקוח'])}</p>
                        <p class="text-sm text-gray-500">${escapeHTML(order['כתובת'] || '')}</p>
                    </div>
                    ${order._effectiveStatus !== 'סגור' ? `<span class="status-badge ${badgeClass}">${badgeText}</span>` : ''}
                </div>
                <div class="mt-4 flex justify-between text-sm text-gray-600">
                    <span>תעודה: <strong>${order['תעודה']}</strong></span>
                    <span><strong>${order._daysPassedCalculated}</strong> ימים בשירות</span>
                </div>
            </div>`;
    }

    // --- BOTTOM SHEET ---
    function openSheet(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) return;
        
        const contentEl = document.getElementById('sheet-content');
        contentEl.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">${escapeHTML(order['שם לקוח'])}</h2>
            <div class="space-y-3 text-gray-700">
                <p><strong>תעודה:</strong> ${order['תעודה']}</p>
                <p><strong>סטטוס:</strong> <span class="font-bold status-${order._effectiveStatus}">${order._effectiveStatus}</span></p>
                <p><strong>תאריך הזמנה:</strong> ${formatDate(order['תאריך הזמנה'])}</p>
                <p><strong>ימים בשירות:</strong> ${order._daysPassedCalculated}</p>
                <p><strong>כתובת:</strong> ${escapeHTML(order['כתובת'] || 'לא צוינה')}</p>
                <p><strong>סוג פעולה:</strong> ${escapeHTML(order['סוג פעולה'] || 'לא צוין')}</p>
                ${order['מספר מכולה ירדה'] ? `<p><strong>מכולה ירדה:</strong> ${escapeHTML(order['מספר מכולה ירדה'])}</p>`: ''}
            </div>
            <div class="mt-6 border-t pt-4 flex gap-2">
                <button class="flex-1 btn btn-primary"><i class="fab fa-whatsapp"></i></button>
                <button class="flex-1 btn btn-secondary"><i class="fas fa-print"></i></button>
                <button class="flex-1 btn btn-secondary"><i class="fas fa-edit"></i></button>
            </div>
        `;

        document.getElementById('bottom-sheet').classList.add('active');
        document.getElementById('bottom-sheet-overlay').classList.add('active');
    }

    function closeSheet() {
        document.getElementById('bottom-sheet').classList.remove('active');
        document.getElementById('bottom-sheet-overlay').classList.remove('active');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeTheme();
        loadOrders();
    });

</script>
</body>
</html>

