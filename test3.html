<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>לוח בקרה - מעקב</title>
<style>
/* =============================================================================
   GEMINI-COMMAND (read this comment):
   - צור/הדבק את הקבצים הבאים:
     1) Code.gs (כפי שסופק) בפרויקט Apps Script שמחובר ל-SHEET ID הנתון.
     2) index.html (הקובץ הזה) כעמוד סטטי (github.io) או הכן לארח בתוך Apps Script.
   - וודא לפרוס Web App כ-"Anyone" ולקחת את ה-DEPLOY URL.
   - עדכן את הערך API_URL ב-JS למטה עם הכתובת.
   - ה-CSS למטה כולל הוראות עיצוב; שינויים ב-CSS כאן יושמו ישירות על ה־UI.
   =============================================================================*/

/* :root - ערכי צבעים וגדלים שניתן לשנות */
:root{
  --brand:#0b72b9;
  --accent:#ff9f1c;
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --radius:10px;
  --shadow: 0 6px 18px rgba(10,25,47,0.08);
  --rtl: 1;
  font-size: 16px;
}

*{box-sizing:border-box}
body{
  margin:0; padding:18px; font-family: "Heebo", "Alef", Arial, sans-serif;
  background:var(--bg); color:#0b1721; direction:rtl;
}

/* Header */
.header{
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  margin-bottom:16px;
}
.brand { display:flex; gap:12px; align-items:center; }
.logo{
  width:56px; height:56px; background:linear-gradient(135deg,var(--brand),#0369a1);
  border-radius:12px; box-shadow:var(--shadow); color:white; display:flex;
  align-items:center; justify-content:center; font-weight:700;
}
.controls { display:flex; gap:8px; align-items:center; }

/* layout */
.container { display:grid; grid-template-columns: 320px 1fr 380px; gap:16px; align-items:start; }
@media (max-width:1000px){ .container { grid-template-columns: 1fr; } .right, .left { order:99 } }

/* left panel (filters) */
.left { background:var(--card); padding:12px; border-radius:var(--radius); box-shadow:var(--shadow); }
.kpi { display:flex; gap:8px; flex-direction:column; }
.kpi-row { display:flex; gap:8px; justify-content:space-between; }
.kpi-card { flex:1; background:linear-gradient(180deg,#fff,var(--card)); padding:12px; border-radius:8px; box-shadow:0 4px 10px rgba(12,28,52,0.04); text-align:center; }
.kpi-number { font-size:20px; font-weight:700; }

/* center - main table */
.main { background:var(--card); padding:12px; border-radius:var(--radius); box-shadow:var(--shadow); overflow-x: auto; }
.toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
.search { flex:1; padding:8px 12px; border-radius:8px; border:1px solid #e6eef8; background:#fbfdff; }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { padding:8px; border-bottom:1px solid #eef5fb; text-align:center; font-size:14px; white-space: nowrap;}
.table th { background:#f8fbff; font-weight:700; color:var(--brand) }

/* right panel - notifications & tools */
.right { background:var(--card); padding:12px; border-radius:var(--radius); box-shadow:var(--shadow); }
.alert { background:#fff4f0; border-left:4px solid #ff8a4b; padding:8px; border-radius:6px; margin-bottom:8px; }
.note-area { width:100%; min-height:120px; padding:8px; border-radius:8px; border:1px solid #e6eef8; margin-top:8px; }

/* side-detail overlay */
.side-detail {
  position:fixed; top:80px; right:20px; width:420px; background:var(--card); padding:14px; border-radius:12px; box-shadow:var(--shadow);
  max-height:70vh; overflow:auto; z-index:60;
}

/* small helpers */
.btn { background:var(--brand); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
.btn.secondary{ background:#e6f1fb; color:var(--brand); }
.btn.danger { background: #fbe6e6; color: #dc2626; }


/* Roadmap Styles */
.roadmap-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 4px;
  border-bottom: 1px solid #f0f3f7;
}
.roadmap-item:last-child {
  border-bottom: none;
}
.roadmap-icon {
  flex-shrink: 0;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: #eef5fb;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
}
.roadmap-content {
  flex-grow: 1;
}
.roadmap-title {
  font-weight: 600;
  font-size: 14px;
}
.roadmap-status {
  font-size: 11px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 99px;
}
.roadmap-status.in-progress {
  background-color: #fef3c7;
  color: #92400e;
}
.roadmap-status.next-up {
  background-color: #eef2ff;
  color: #4f46e5;
}
.roadmap-status.future {
  background-color: #f3f4f6;
  color: #4b5563;
}


/* mobile adjustments */
@media (max-width:600px){
  .header { flex-direction:column; align-items:stretch; gap:10px; }
  .container { grid-template-columns: 1fr; }
  .side-detail { position:fixed; left:8px; right:8px; top:70px; width:auto; }
}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">ח.סבן</div>
      <div>
        <div style="font-weight:700;font-size:18px">לוח בקרה - מעקב מכולות</div>
        <div style="color:var(--muted);font-size:13px">חיבור לגליון: מעקב</div>
      </div>
    </div>

    <div class="controls">
      <input id="globalSearch" class="search" placeholder="חפש (מספר הזמנה, לקוח, כתובת...)" oninput="applyFilter()" />
      <button class="btn" onclick="refresh()">רענן</button>
      <button class="btn secondary" onclick="openNewOrder()">הזמנה חדשה</button>
    </div>
  </div>

  <div class="container">
    <div class="left">
      <div style="font-weight:700;margin-bottom:8px">KPIs</div>
      <div class="kpi">
        <div class="kpi-row">
          <div class="kpi-card"><div style="color:var(--muted)">סה״כ הזמנות</div><div id="kTotal" class="kpi-number">—</div></div>
          <div class="kpi-card"><div style="color:var(--muted)">פתוחות</div><div id="kOpen" class="kpi-number">—</div></div>
        </div>
        <div class="kpi-row" style="margin-top:8px">
          <div class="kpi-card"><div style="color:var(--muted)">חורגות</div><div id="kOver" class="kpi-number">—</div></div>
          <div class="kpi-card"><div style="color:var(--muted)">מכולות בשימוש</div><div id="kContainers" class="kpi-number">—</div></div>
        </div>
      </div>

      <hr style="margin:12px 0" />
      <div style="font-weight:700;margin-bottom:6px">כלים לפיתוח</div>
      <div style="font-size:13px;color:var(--muted)">
        כאן תוכל לכתוב רעיונות, משימות או טיקט מהיר לצוות הפיתוח — לשמור ישירות בגליון כתזכורת.
      </div>
      <textarea id="devNote" class="note-area" placeholder="כתוב הערה/רשימת משימות..."></textarea>
      <div style="margin-top:8px; display:flex; gap:8px">
        <button class="btn" onclick="saveDevNote()">שמור הערה</button>
        <button class="btn secondary" onclick="loadDevNotes()">טען הערות</button>
      </div>
    </div>

    <div class="main">
      <div class="toolbar">
        <div style="font-weight:700">טבלת הזמנות</div>
        <div style="flex:1"></div>
        <div id="statusMsg" style="color:var(--muted);font-size:13px"></div>
      </div>

      <table class="table" id="ordersTable">
        <thead id="tHead"></thead>
        <tbody id="tBody"></tbody>
      </table>
    </div>

    <div class="right">
      <div style="font-weight:700;margin-bottom:8px">התראות</div>
      <div id="alerts"></div>

      <hr style="margin:12px 0" />
      <div style="font-weight:700; margin-bottom: 8px;">תוכנית פיתוח - הצעדים הבאים</div>
      <div id="roadmap">
        <div class="roadmap-item">
          <div class="roadmap-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><path d="M10.6 13.4c-.9-.9-.9-2.3 0-3.2"/><path d="M13.4 10.6c.9.9.9 2.3 0 3.2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
          </div>
          <div class="roadmap-content">
            <div class="roadmap-title">שילוב בזמן אמת</div>
          </div>
          <div class="roadmap-status in-progress">בתהליך</div>
        </div>
        <div class="roadmap-item">
          <div class="roadmap-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
          </div>
          <div class="roadmap-content">
            <div class="roadmap-title">אימות והרשאות</div>
          </div>
          <div class="roadmap-status next-up">הבא בתור</div>
        </div>
        <div class="roadmap-item">
          <div class="roadmap-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="14 2 18 6 7 17 3 17 3 13 14 2"></polygon><line x1="3" y1="22" x2="21" y2="22"></line></svg>
          </div>
          <div class="roadmap-content">
            <div class="roadmap-title">שיפורי UI/UX</div>
          </div>
           <div class="roadmap-status future">בעתיד</div>
        </div>
        <div class="roadmap-item">
          <div class="roadmap-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          </div>
          <div class="roadmap-content">
            <div class="roadmap-title">יצוא PDF וחתימה</div>
          </div>
           <div class="roadmap-status future">בעתיד</div>
        </div>
        <div class="roadmap-item">
           <div class="roadmap-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          </div>
          <div class="roadmap-content">
            <div class="roadmap-title">שילוב מפות וניווט</div>
          </div>
           <div class="roadmap-status future">בעתיד</div>
        </div>
      </div>
    </div>
  </div>

  <!-- side detail -->
  <div id="sideDetail" class="side-detail" style="display:none"></div>

<script>
/* ========== CONFIG ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec"; // <-- החלף כאן בכתובת ה־WebApp שלך

/* ========== Helpers: API wrappers ========== */
async function apiGet(action) {
  const res = await fetch(`${API_URL}?action=${action}`);
  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  return await res.json();
}
async function apiPost(body) {
  const res = await fetch(API_URL, {
    method: "POST",
    // Apps Script requires 'text/plain' for this method of deployment
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  return await res.json();
}

/* ========== Date formatting (fix for ISO 'Z' format) ========== */
function formatDateTime(value) {
  if (!value && value !== 0) return "";
  let d = (value instanceof Date) ? value : new Date(value);
  if (isNaN(d.getTime())) return value; // fallback if not date

  // localize to Israel / Hebrew
  try {
    const dateStr = d.toLocaleDateString("he-IL", { day: "2-digit", month: "2-digit", year: "numeric" });
    const timeStr = d.toLocaleTimeString("he-IL", { hour: "2-digit", minute: "2-digit" });
    if (d.getHours() === 0 && d.getMinutes() === 0 && d.getSeconds() === 0) return dateStr;
    return `${dateStr}, ${timeStr}`;
  } catch (e) {
      return value; // Fallback for invalid dates
  }
}

function looksLikeDateHeader(h) {
  if (!h) return false;
  const s = String(h).toLowerCase();
  return s.includes("תאריך") || s.includes("date") || s.includes("סיום");
}

/* ========== State ========== */
let rawData = [];
let headers = [];
let isRefreshing = false;


/* ========== UI renderers ========== */
function renderTable(data, hdrs) {
  const scrollY = window.scrollY; // Preserve scroll position
  headers = hdrs;
  const thead = document.getElementById("tHead");
  const tbody = document.getElementById("tBody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!hdrs || hdrs.length === 0) {
    thead.innerHTML = "<tr><th>אין נתונים להצגה. יש לוודא שהוגדרו כותרות בגליון 'מעקב'.</th></tr>";
    return;
  }

  thead.innerHTML = "<tr>" + hdrs.map(h => `<th>${h}</th>`).join("") + "<th>פעולות</th></tr>";

  data.forEach((rowObj, idx) => {
    const cells = hdrs.map(h => {
      const v = rowObj[h];
      if (looksLikeDateHeader(h)) return `<td>${formatDateTime(v)}</td>`;
      if (String(h).includes("טלפון") && v) {
        return `<td><a href="tel:${v}">${v}</a></td>`;
      }
      if (String(h).includes("כתובת") && v) {
        return `<td><button class="btn secondary" style="padding: 4px 8px; font-size: 12px;" onclick="openMap('${encodeURIComponent(v)}')">מפה</button></td>`;
      }
      return `<td>${v === null || v === undefined ? "" : v}</td>`;
    }).join("");

    const actionCell = `<td style="display: flex; gap: 4px;">
      <button class="btn secondary" onclick="showDetail(${idx})">פרטים</button>
      <button class="btn" onclick="editRowPrompt(${idx})">ערוך</button>
      <button class="btn danger" onclick="deleteRowByIdx(${idx})">מחק</button>
      </td>`;

    tbody.innerHTML += `<tr>${cells}${actionCell}</tr>`;
  });
  window.scrollTo(0, scrollY); // Restore scroll position
}

/* ========== KPI + Alerts ========== */
function computeKPIs(data, hdrs) {
  const total = data.length;
  const statusField = hdrs.find(h => String(h).includes("סטטוס")) || hdrs[hdrs.length-1];
  const dateField = hdrs.find(h => String(h).includes("סיום"));

  const open = data.filter(r => {
    const s = statusField ? String(r[statusField] || "").toLowerCase() : "";
    return s !== "סגור" && s !== "closed" && s !== "סגורה";
  }).length;
  
  let overdue = [];
  if (dateField) {
    const today = new Date(); 
    today.setHours(0, 0, 0, 0); // Start of today
    overdue = data.filter(r => {
      const v = r[dateField];
      if (!v) return false;
      const d = new Date(v);
      if (isNaN(d.getTime())) return false;
      d.setHours(0,0,0,0);
      const isOpen = (String(r[statusField] || "").toLowerCase() !== "סגור");
      return isOpen && d < today;
    });
  }

  document.getElementById("kTotal").innerText = total;
  document.getElementById("kOpen").innerText = open;
  document.getElementById("kOver").innerText = overdue.length;

  const alerts = document.getElementById("alerts");
  alerts.innerHTML = "";
  if (overdue.length === 0) {
    alerts.innerHTML = "<div style='color:var(--muted)'>אין חריגות</div>";
  } else {
    overdue.slice(0, 6).forEach(o => {
      const title = (o["שם לקוח"] || o["לקוח"] || "לקוח לא ידוע");
      const end = formatDateTime(o[dateField]);
      alerts.innerHTML += `<div class="alert"><div style="font-weight:700">${title}</div><div style="font-size:13px">תאריך סיום חורג: ${end}</div></div>`;
    });
  }
}

/* ========== Actions ========== */
async function refresh() {
  if (isRefreshing) return; // Prevent multiple refreshes at once
  isRefreshing = true;

  const statusMsg = document.getElementById("statusMsg");
  statusMsg.innerText = "מרענן...";
  try {
    const resp = await apiGet("getData");
    if (resp.status === "success") {
      const searchVal = document.getElementById("globalSearch").value;
      // Only re-render if data has actually changed, unless there's a search query
      if (JSON.stringify(rawData) !== JSON.stringify(resp.data) || searchVal) {
          rawData = resp.data || [];
          applyFilter(); // Apply current filter to new data
      }
      computeKPIs(rawData, resp.headers || (rawData[0] ? Object.keys(rawData[0]) : []));
      statusMsg.innerText = `עודכן לאחרונה: ${new Date().toLocaleTimeString('he-IL')}`;
    } else {
      statusMsg.innerText = "שגיאה: " + resp.message;
    }
  } catch (err) {
    statusMsg.innerText = "שגיאת רשת: " + err.message;
  } finally {
    isRefreshing = false;
  }
}

function showDetail(idx) {
  const data = rawData.filter(r => {
    const q = document.getElementById("globalSearch").value.trim().toLowerCase();
    if (!q) return true;
    return Object.values(r).some(v => String(v || "").toLowerCase().includes(q));
  })[idx];

  if (!data) return;
  const side = document.getElementById("sideDetail");
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">פרטי הזמנה</div><button onclick="closeDetail()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button></div><hr/>`;
  for (const k in data) {
    const v = looksLikeDateHeader(k) ? formatDateTime(data[k]) : data[k];
    html += `<div style="margin-bottom:6px"><div style="color:var(--muted);font-size:13px">${k}</div><div style="font-weight:600">${v || ''}</div></div>`;
  }
  const originalIndex = rawData.findIndex(item => item === data);
  html += `<div style="margin-top:12px;display:flex;gap:8px;"><button class="btn" onclick="sendWhatsApp(${originalIndex})">שלח WhatsApp</button> <button class="btn secondary" onclick="closeDetail()">סגור</button></div>`;
  side.innerHTML = html;
  side.style.display = "block";
}
function closeDetail(){ document.getElementById("sideDetail").style.display = "none" }

function openMap(q) {
  window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
}

function editRowPrompt(idx) {
  const filteredData = rawData.filter(r => {
    const q = document.getElementById("globalSearch").value.trim().toLowerCase();
    if (!q) return true;
    return Object.values(r).some(v => String(v || "").toLowerCase().includes(q));
  });
  const originalRow = filteredData[idx];
  if (!originalRow) return;

  const newRowData = {};
  for(const header of headers) {
      const val = prompt(`ערוך שדה "${header}"`, originalRow[header] || "");
      if (val === null) return; // User cancelled
      newRowData[header] = val;
  }
  
  const newRowArray = headers.map(h => newRowData[h]);
  const originalIndex = rawData.findIndex(item => item === originalRow);

  apiPost({ action: "updateRow", index: originalIndex, row: newRowArray }).then(r => {
    alert(r.message);
    refresh();
  }).catch(e => alert("שגיאה בעדכון: " + e.message));
}
function openNewOrder() {
  if (!headers || headers.length === 0) {
      alert("לא ניתן להוסיף הזמנה. יש להגדיר כותרות בגליון תחילה.");
      return;
  }
  const row = headers.map(c => prompt(`הזן ערך עבור: ${c}`, ""));
  if (row.some(val => val === null)) return; // User cancelled

  apiPost({ action: "addRow", row: row }).then(r => { alert(r.message); refresh(); }).catch(e => alert(e.message));
}

function deleteRowByIdx(idx) {
  const filteredData = rawData.filter(r => {
    const q = document.getElementById("globalSearch").value.trim().toLowerCase();
    if (!q) return true;
    return Object.values(r).some(v => String(v || "").toLowerCase().includes(q));
  });
  const rowToDelete = filteredData[idx];
  const identifier = rowToDelete[headers[0]] || `שורה ${idx+1}`;
  if (!confirm(`האם למחוק את "${identifier}"?`)) return;
  
  const originalIndex = rawData.findIndex(item => item === rowToDelete);
  apiPost({ action: "deleteRow", index: originalIndex }).then(r => { 
      alert(r.message); 
      refresh(); 
  }).catch(e => alert(e.message));
}

function sendWhatsApp(idx) {
  const row = rawData[idx];
  if (!row) return;
  const phoneField = headers.find(h => h.includes("טלפון") || h.includes("phone"));
  const clientField = headers.find(h => h.includes("שם") || h.includes("לקוח"));
  const phone = phoneField ? row[phoneField] : "";
  const client = clientField ? row[clientField] : "לקוח";
  const text = encodeURIComponent(`שלום ${client}, בדיקת סטטוס הזמנה.`);
  if (!phone) { alert("לא נמצא מספר טלפון עבור הזמנה זו."); return; }
  const cleanPhone = String(phone).replace(/[^0-9]/g,'');
  window.open(`https://wa.me/972${cleanPhone.substring(cleanPhone.length-9)}?text=${text}`, "_blank");
}

/* Dev notes */
async function saveDevNote(){
  const text = document.getElementById("devNote").value.trim();
  if (!text) { alert("יש לכתוב תוכן להערה."); return; }
  const note = { author: "מנהל", text: text };
  const resp = await apiPost({ action: "saveDevNote", note: note });
  alert(resp.message || "ההערה נשמרה");
  document.getElementById("devNote").value = "";
}
async function loadDevNotes(){
  const resp = await apiGet("getDevNotes");
  if (resp.status === "success" && resp.notes && resp.notes.length) {
    const latest = resp.notes.slice(-5).reverse().map(n => `${formatDateTime(n.timestamp)} — ${n.author}: ${n.note}`).join("\n\n");
    document.getElementById("devNote").value = latest;
  } else {
    document.getElementById("devNote").value = "";
    alert("לא נמצאו הערות קודמות.");
  }
}

/* search filter */
function applyFilter(){
  const q = document.getElementById("globalSearch").value.trim().toLowerCase();
  const filtered = rawData.filter(r => {
    if (!q) return true; // show all if search is empty
    return Object.values(r).some(v => String(v || "").toLowerCase().includes(q));
  });
  renderTable(filtered, headers);
}

/* initial load */
document.addEventListener('DOMContentLoaded', () => {
  refresh(); // Load data on start
  setInterval(refresh, 30000); // And refresh every 30 seconds
});
</script>
</body>
</html>

