<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转专转 WhatsApp </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for charts (if needed for context, though not directly used on this page for now) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet for maps (if needed for context, though not directly used on this page for now) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Google Fonts - Rubik for Hebrew support -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Calm Neutral Harmony Palette */
            --color-primary: #2e8b57; /* Sea Green - main accent */
            --color-primary-dark: #287a4d;
            --color-secondary: #607d8b; /* Blue Gray - secondary accent */
            --color-secondary-dark: #526b78;
            --color-accent: #4a90e2; /* A slightly brighter blue for interactive elements */
            --color-info: #3498db;   /* Standard blue for info */
            --color-success: #28a745; /* Green for success */
            --color-warning: #ffc107; /* Yellow for warning */
            --color-danger: #dc3545; /* Red for danger */
            --color-danger-dark: #c82333;

            /* Neutral Tones for Backgrounds and Text */
            --color-background: #f8f9fa; /* Light background */
            --color-surface: #ffffff;    /* Card backgrounds, lighter surfaces */
            --color-border: #e0e0e0;     /* Light gray for borders */
            --color-text-base: #333333;  /* Dark gray for main text */
            --color-text-muted: #6c757d; /* Lighter gray for secondary text */

            /* Dark Mode Overrides (for smooth transition) */
            --dark-color-background: #1a202c;
            --dark-color-surface: #2d3748;
            --dark-color-border: #4a5568;
            --dark-color-text-base: #e2e8f0;
            --dark-color-text-muted: #a0aec0;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-base);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        body.dark {
            background-color: var(--dark-color-background);
            color: var(--dark-color-text-base);
        }

        /* Dark mode transitions */
        body.dark .card {
            background-color: var(--dark-color-surface);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        body.dark .border { border-color: var(--dark-color-border); }
        body.dark .text-gray-700 { color: var(--dark-color-text-base); }
        body.dark .text-gray-500 { color: var(--dark-color-text-muted); }
        body.dark .bg-gray-200 { background-color: var(--dark-color-border); }
        body.dark .hover\:bg-gray-300:hover { background-color: var(--dark-color-surface); }
        body.dark input, body.dark textarea, body.dark select {
            background-color: var(--dark-color-background);
            border-color: var(--dark-color-border);
            color: var(--dark-color-text-base);
        }
        body.dark table th, body.dark table td { border-color: var(--dark-color-border); }
        body.dark table thead th { background-color: var(--dark-color-surface); }
        body.dark .status-驻转 { background-color: rgba(40, 167, 69, 0.2); color: var(--color-success); }
        body.dark .status-专 { background-color: rgba(220, 53, 69, 0.2); color: var(--color-danger); }
        body.dark .status-住专 { background-color: rgba(108, 117, 125, 0.2); color: var(--color-text-muted); }

        /* General styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background-color: var(--color-surface);
            border-radius: 0.75rem; /* Rounded corners for cards */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--color-primary-dark);
        }

        .btn-danger {
            background-color: var(--color-danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--color-danger-dark);
        }

        .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .action-icon-btn:hover {
            background-color: var(--color-border);
        }
        body.dark .action-icon-btn:hover {
            background-color: var(--dark-color-border);
        }

        /* Status badges */
        .status-驻转 {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-专 {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--color-danger);
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-住专 {
            background-color: rgba(108, 117, 125, 0.1);
            color: var(--color-text-muted);
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Animated timer and lightbulb indicators */
        .automated-alerts-status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
            gap: 0.5rem; /* Space between icon and text */
        }
        .animate-pulse-red {
            animation: pulse-red 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        .animate-pulse-green {
            animation: pulse-green 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-red {
            0%, 100% {
                background-color: rgba(254, 226, 226, 0.7); /* red-100, slightly transparent */
                box-shadow: 0 0 0px 0px rgba(239, 68, 68, 0.4); /* red-500 shadow */
            }
            50% {
                background-color: rgba(254, 226, 226, 1); /* red-100 opaque */
                box-shadow: 0 0 0px 4px rgba(239, 68, 68, 0.6); /* red-500 shadow */
            }
        }
        @keyframes pulse-green {
            0%, 100% {
                background-color: rgba(209, 250, 229, 0.7); /* green-100, slightly transparent */
                box-shadow: 0 0 0px 0px rgba(16, 185, 129, 0.4); /* green-500 shadow */
            }
            50% {
                background-color: rgba(209, 250, 229, 1); /* green-100 opaque */
                box-shadow: 0 0 0px 4px rgba(16, 185, 129, 0.6); /* green-500 shadow */
            }
        }

        /* WhatsApp Status Lightbulb Indicator */
        .whatsapp-status-indicator {
            position: relative;
            cursor: help;
        }
        .whatsapp-status-indicator .whatsapp-status-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
            bottom: 100%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%) translateY(-0.5rem); /* Adjust vertical position */
            pointer-events: none; /* Allows click-through */
        }
        .whatsapp-status-indicator:hover .whatsapp-status-tooltip,
        .whatsapp-status-indicator:focus-within .whatsapp-status-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-1rem); /* Slight move up on hover */
        }
        /* Mobile/Touch support for tooltip */
        @media (max-width: 768px) {
            .whatsapp-status-indicator .whatsapp-status-tooltip {
                display: none; /* Hide by default on small screens */
            }
            .whatsapp-status-indicator.active .whatsapp-status-tooltip {
                display: block; /* Show on active/tap */
                visibility: visible;
                opacity: 1;
                transform: translateX(-50%) translateY(-1rem);
            }
        }

        .animate-pulse-red-lightbulb {
            animation: pulse-red-lightbulb 1.5s infinite;
        }
        .animate-pulse-green-lightbulb {
            animation: pulse-green-lightbulb 1.5s infinite;
        }

        @keyframes pulse-red-lightbulb {
            0%, 100% { color: var(--color-danger); opacity: 0.7; }
            50% { color: var(--color-danger); opacity: 1; }
        }
        @keyframes pulse-green-lightbulb {
            0%, 100% { color: var(--color-success); opacity: 0.7; }
            50% { color: var(--color-success); opacity: 1; }
        }
        body.dark .animate-pulse-red-lightbulb {
             animation: pulse-red-lightbulb-dark 1.5s infinite;
        }
        body.dark .animate-pulse-green-lightbulb {
            animation: pulse-green-lightbulb-dark 1.5s infinite;
        }
        @keyframes pulse-red-lightbulb-dark {
            0%, 100% { color: #f87171; opacity: 0.7; } /* Red-400 equivalent for dark mode */
            50% { color: #ef4444; opacity: 1; } /* Red-500 equivalent for dark mode */
        }
        @keyframes pulse-green-lightbulb-dark {
            0%, 100% { color: #86efac; opacity: 0.7; } /* Green-300 equivalent for dark mode */
            50% { color: #4ade80; opacity: 1; } /* Green-400 equivalent for dark mode */
        }

        /* Layout for alert buttons */
        .alert-action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Space between buttons */
            justify-content: flex-start; /* Align to start */
        }
        .alert-action-buttons .btn {
            min-width: 120px; /* Minimum width for buttons */
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        /* Generic table styling */
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }
        table th, table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        table thead th {
            background-color: var(--color-background);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
        }
        body.dark table thead th {
            background-color: var(--dark-color-surface);
        }

        /* Modal specific styling (simplified for this standalone page) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: var(--color-primary);
        }

        /* Loader */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        body.dark #loader-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--color-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        body.dark .loader {
             border: 8px solid #2d3748;
             border-top: 8px solid var(--color-primary);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert container */
        #alert-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 90%;
            width: 300px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Loader Overlay -->
    <div id="loader-overlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-50 transition-opacity opacity-0 pointer-events-none">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="z-50"></div>

    <div class="container mx-auto p-6 lg:p-8">
        <header class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-4 mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fab fa-whatsapp text-green-500"></i>  转专转 WhatsApp
            </h1>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <main>
            <div id="whatsapp-alerts-page" class="page-content p-6 animate-fade-in">
                <h2 class="text-2xl font-bold mb-6 text-[var(--color-primary)]">转专转 住驻 拽转 </h2>
                
                <!--  专 砖注 注爪专 驻转专 砖转 转专转 转 -->
                <div id="automated-alerts-status-container" class="automated-alerts-status-container bg-red-100 text-red-700 mb-6 text-center">
                    <i class="fas fa-hourglass-half ml-2"></i> 转专转 转 砖 注: <span id="automated-alerts-timer" class="font-bold text-red-700">00:00:00</span>
                </div>

                <div class="flex flex-wrap gap-4 justify-center mb-6">
                    <button id="send-all-overdue-alerts-btn" class="btn bg-[var(--color-danger)] text-white hover:bg-[var(--color-danger-dark)] transition-colors py-2 px-4 rounded-lg shadow-md">
                        <i class="fas fa-exclamation-triangle ml-2"></i> 砖 转专转 转  拽转 专
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- 驻专 拽 -->
                    <div class="card p-5 bg-[var(--color-surface)] shadow-md rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-[var(--color-primary)]">驻专 拽</h3>
                        <div class="mb-4">
                            <label for="whatsapp-customer-name" class="block text-sm font-medium text-[var(--color-text-muted)]">砖 拽</label>
                            <input type="text" id="whatsapp-customer-name" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-[var(--color-background)] border-[var(--color-border)] text-[var(--color-text-base)]" readonly>
                        </div>
                        <div class="mb-4">
                            <label for="whatsapp-phone-number" class="block text-sm font-medium text-[var(--color-text-muted)]">住驻专 驻</label>
                            <input type="text" id="whatsapp-phone-number" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-[var(--color-background)] border-[var(--color-border)] text-[var(--color-text-base)]" readonly>
                        </div>
                        <div class="mb-4">
                            <label for="whatsapp-address" class="block text-sm font-medium text-[var(--color-text-muted)]">转转</label>
                            <input type="text" id="whatsapp-address" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-[var(--color-background)] border-[var(--color-border)] text-[var(--color-text-base)]" readonly>
                        </div>
                        <p class="text-xs text-[var(--color-text-muted)]"> : <span id="details-order-id" class="font-semibold"></span></p>
                    </div>

                    <!-- 专转 转转 注 -->
                    <div class="card p-5 bg-[var(--color-surface)] shadow-md rounded-lg col-span-1 md:col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-[var(--color-primary)]">转 注转 WhatsApp</h3>
                        <div class="mb-4">
                            <label for="message-template-select" class="block text-sm font-medium text-[var(--color-text-muted)]">专 转转 注</label>
                            <select id="message-template-select" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-[var(--color-background)] border-[var(--color-border)] text-[var(--color-text-base)]" onchange="loadWhatsAppTemplate()">
                                <option value="">专 转转...</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="whatsapp-message-input" class="block text-sm font-medium text-[var(--color-text-muted)]">注</label>
                            <textarea id="whatsapp-message-input" rows="7" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-[var(--color-background)] border-[var(--color-border)] text-[var(--color-text-base)]"></textarea>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="clearWhatsAppMessage()" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors py-2 px-4 rounded-lg shadow-md">拽</button>
                            <button onclick="sendWhatsAppMessage()" class="btn bg-green-500 text-white hover:bg-green-600 transition-colors py-2 px-4 rounded-lg shadow-md">
                                <i class="fab fa-whatsapp ml-2"></i> 砖
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-[var(--color-surface)] p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-[var(--color-primary)]">转 专砖转 驻</h3>
                    <p id="no-alerts-needed" class="text-center text-[var(--color-text-muted)] py-4 hidden"> !  转 专砖转 驻 专注.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-[var(--color-border)] text-right" dir="rtl">
                            <thead>
                                <tr>
                                    <th class="px-3 py-3 bg-[var(--color-background)] text-xs font-medium text-[var(--color-text-muted)] uppercase tracking-wider">转注</th>
                                    <th class="px-3 py-3 bg-[var(--color-background)] text-xs font-medium text-[var(--color-text-muted)] uppercase tracking-wider">拽</th>
                                    <th class="px-3 py-3 bg-[var(--color-background)] text-xs font-medium text-[var(--color-text-muted)] uppercase tracking-wider">住住</th>
                                    <th class="px-3 py-3 bg-[var(--color-background)] text-xs font-medium text-[var(--color-text-muted)] uppercase tracking-wider"> 砖注专</th>
                                    <th class="px-3 py-3 bg-[var(--color-background)] text-xs font-medium text-[var(--color-text-muted)] uppercase tracking-wider">驻注转</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-table-body" class="bg-[var(--color-surface)] divide-y divide-[var(--color-border)]">
                                <!-- Alerts will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL of your Google Apps Script acting as the API for main CRM data
        // 锔  祝 转  -URL 转 砖 砖 专 砖 -Google Apps Script 专砖 砖.
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec'; 

        // URL 砖 住拽专驻 Apps Script 驻专 专砖 注转 WhatsApp  转转
        //   注!  -URL 砖 驻专住转 砖 专 砖 住拽专驻 -WhatsApp 砖 砖爪专转!
        const WHATSAPP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzP0wjHzQrvo0pzSigKuJX25xvqIck8IQGXildOp-BEOqaT5Yvf9odw4_OeP4y9dyEzrQ/exec'; 

        //  砖! 专转 砖注转 专专  (砖注 驻专 24 砖注转)
        const AUTOMATED_TRIGGER_HOUR = 8; // 08:00 拽专
        const AUTOMATED_TRIGGER_MINUTE = 0; // 00 拽转

        let allOrders = []; // Array containing all loaded orders (simplified for this standalone page)
        let whatsappTemplates = []; // 注 -Apps Script
        let whatsappLogSummary = {}; // 住 住  WhatsApp
        let timerIntervalId = null; // 砖专转 ID 砖 砖注 注爪专
        const OVERDUE_THRESHOLD_DAYS = 10; // 住驻专  注专 转专  砖 '专'


        // --- Theme Toggle Functions ---
        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.querySelector('#theme-toggle i').className = isDarkMode ? 'fas fa-moon' : 'fas fa-sun';
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark');
                document.querySelector('#theme-toggle i').className = 'fas fa-moon';
            }
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        }

        // --- Alert Notification Function ---
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertItem = document.createElement('div');
            let bgColor, icon, textColor, borderColor;
            switch(type) {
                case 'success': bgColor = 'bg-green-50'; borderColor = 'border-green-500'; textColor = 'text-green-700'; icon = 'fa-check-circle'; break;
                case 'error': bgColor = 'bg-red-50'; borderColor = 'border-red-500'; textColor = 'text-red-700'; icon = 'fa-times-circle'; break;
                case 'warning': bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-700'; icon = 'fa-exclamation-triangle'; break;
                default: bgColor = 'bg-blue-50'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; icon = 'fa-info-circle'; break;
            }
            alertItem.className = `p-4 rounded-lg border-l-4 shadow-md flex items-center gap-3 transform translate-x-full opacity-0 transition-all duration-500 ease-out ${bgColor} ${borderColor} ${textColor}`;
            alertItem.innerHTML = `<i class="fas ${icon}"></i><p>${message}</p>`;
            container.prepend(alertItem);
            
            setTimeout(() => {
                alertItem.style.transform = 'translateX(0)';
                alertItem.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                alertItem.style.transform = 'translateX(100%)';
                alertItem.style.opacity = '0';
                setTimeout(() => alertItem.remove(), 500);
            }, 5000);
        }

        // --- API Communication Function (Exponential Backoff) ---
        // Simplified fetchData for this standalone page, only for WHATSAPP_SCRIPT_URL
        async function fetchData(action, params = {}, retries = 0) {
            showLoader();
            const urlParams = new URLSearchParams({ action, ...params });
            const url = `${WHATSAPP_SCRIPT_URL}?${urlParams.toString()}`;
            console.log(`[fetchData] Request URL: ${url}`);
            try {
                const response = await fetch(url);
                console.log(`[fetchData] Response status: ${response.status}`);
                const data = await response.json();
                console.log(`[fetchData] Response data:`, data);

                if (!response.ok) {
                    const errorMessage = data.message || `砖转 砖专转 HTTP: ${response.status}`;
                    showAlert(errorMessage, 'error');
                    console.error("[fetchData] HTTP error:", errorMessage, data);
                    return { success: false, message: errorMessage };
                }

                if (!data.success && data.message && data.message.includes('Service invoked too many times')) {
                    const delay = Math.pow(2, retries) * 1000;
                    if (retries < 5) {
                        console.warn(`[fetchData] Service invoked too many times, retrying in ${delay}ms... (Attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchData(action, params, retries + 1); 
                    } else {
                        showAlert('砖专转 注住 ,  住 砖 专 转专.', 'error');
                        return { success: false, message: 'Service too busy' };
                    }
                } else if (!data.success) {
                    showAlert(data.message || '驻注 砖 砖专转.', 'error');
                    console.error("[fetchData] Server-side operation failed:", data.message, data);
                    return data;
                }

                return data;
            } catch (error) {
                showAlert('砖转 转拽砖专转:  转 转专 砖专转.', 'error');
                console.error("[fetchData] Network or parsing error:", error);
                return { success: false, message: error.message };
            } finally {
                hideLoader();
            }
        }
        
        // --- Loader Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.remove('opacity-0', 'pointer-events-none'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('opacity-0', 'pointer-events-none'); }

        // --- WhatsApp Logging and Sending ---
        async function logWhatsAppMessage(orderDocId, customerName, phoneNumber, message, messageType, status = '砖 转', sendType = '') { 
            if (!WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                console.warn("WHATSAPP_SCRIPT_URL  专   placeholder.  转 转注 注转 WhatsApp.");
                return;
            }
            const params = {
                orderDocId: orderDocId,
                customerName: customerName,
                phoneNumber: phoneNumber,
                message: message,
                messageType: messageType,
                status: status,
                sendType: sendType 
            };
            console.log("[logWhatsAppMessage] Sending log request with params:", params); // DEBUG
            const response = await fetchData('logMessage', params, 0, WHATSAPP_SCRIPT_URL);
            if (response.success) {
                console.log("[logWhatsAppMessage] WhatsApp message logged successfully.");
                whatsappLogSummary[`${orderDocId}_${phoneNumber}`] = { 
                    '转专 砖注': new Date().toLocaleString('he-IL'), 
                    '住住': status, 
                    '住 砖': sendType 
                };
                // Re-render relevant parts to update lightbulb status
                renderAlertsTable(); // Update alerts table with new status
            } else {
                console.error("[logWhatsAppMessage] Failed to log WhatsApp message:", response.message);
            }
        }

        function sendWhatsAppMessage() {
            const customerName = document.getElementById('whatsapp-customer-name').value;
            const phoneNumber = document.getElementById('whatsapp-phone-number').value;
            const message = document.getElementById('whatsapp-message-input').value;
            const orderDocId = document.getElementById('details-order-id').textContent;
            const messageType = document.getElementById('message-template-select').value || ''; 

            if (!phoneNumber) {
                showAlert(' 专 拽 注 住驻专 驻   住驻专.', 'warning');
                return;
            }
            if (!message.trim()) {
                showAlert('注 专拽.  转 注  专 转转.', 'warning');
                return;
            }

            console.log("DEBUG: sendWhatsAppMessage - Customer Name:", customerName);
            console.log("DEBUG: sendWhatsAppMessage - Phone Number:", phoneNumber);
            console.log("DEBUG: sendWhatsAppMessage - Order Doc ID:", orderDocId);
            console.log("DEBUG: sendWhatsAppMessage - Message Type:", messageType);


            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('驻转 WhatsApp 砖转 注...', 'info');
            logWhatsAppMessage(orderDocId, customerName, phoneNumber, message, messageType, '砖 转 (驻转 )', '');
        }

        // --- WhatsApp Status Indicator Logic ---
        async function fetchWhatsAppLogSummary() {
            if (!WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                console.warn("WHATSAPP_SCRIPT_URL  专.  转 注 住  WhatsApp.");
                return;
            }
            console.log("[fetchWhatsAppLogSummary] Fetching log summary from:", WHATSAPP_SCRIPT_URL); // DEBUG
            const response = await fetchData('getWhatsAppLogSummary', {}, 0, WHATSAPP_SCRIPT_URL);
            if (response.success && response.data) {
                whatsappLogSummary = response.data;
                console.log("[fetchWhatsAppLogSummary] WhatsApp Log Summary loaded:", whatsappLogSummary); // DEBUG
            } else {
                console.error("[fetchWhatsAppLogSummary] Failed to load WhatsApp Log Summary:", response.message); // DEBUG
                whatsappLogSummary = {}; 
            }
        }

        function getWhatsAppStatusHtml(orderDocId, customerPhoneNumber) {
            if (!orderDocId || !customerPhoneNumber) {
                return ''; 
            }
            const key = `${orderDocId}_${customerPhoneNumber}`;
            const logEntry = whatsappLogSummary[key];

            let iconClass = 'far fa-lightbulb'; 
            let statusText = ' 砖';
            let blinkClass = 'animate-pulse-red-lightbulb'; 
            let textColor = 'text-red-500';

            if (logEntry && logEntry['住住'] && logEntry['住住'].includes('砖')) { 
                iconClass = 'fas fa-lightbulb'; 
                statusText = `砖: ${logEntry['转专 砖注']} (${logEntry['住 砖']})`;
                blinkClass = 'animate-pulse-green-lightbulb'; 
                textColor = 'text-green-500';
            }

            return `
                <span class="whatsapp-status-indicator relative inline-flex items-center group">
                    <i class="${iconClass} text-xl ${textColor} ${blinkClass}"></i>
                    <span class="whatsapp-status-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 text-xs text-white bg-gray-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                        ${statusText}
                    </span>
                </span>
            `;
        }
        
        // --- Data Loading and Processing (Simplified for this page) ---
        async function loadOrders() {
            // For this standalone page, we only need basic order data to get overdue customers
            // In the full app, this would fetch all orders from SCRIPT_WEB_APP_URL
            console.log("[loadOrders] Fetching overdue customers for WhatsApp alerts...");
            const response = await fetchData('getOverdueCustomers', {}, 0, WHATSAPP_SCRIPT_URL); // Use WhatsApp script to get overdue list
            if (response.success && response.data) {
                // response.data here contains sheetRows of overdue orders
                // We need to fetch full order details for these sheetRows.
                // For a real standalone app, 'getOverdueCustomers' in Apps Script should return more details.
                // For now, let's mock it or assume 'allOrders' contains enough.
                
                // For a simplified standalone, we'll fetch full data for *all* orders from the main script.
                // If the main script is not available, we can't fully populate.
                // To keep this truly standalone and functional for WhatsApp,
                // the `getOverdueCustomers` in Apps Script should return *some* order details,
                // or we need to pass a simpler 'list' action to the *main* Apps Script.
                
                // For this exercise, let's assume allOrders will be populated with relevant data if SCRIPT_WEB_APP_URL works.
                // If SCRIPT_WEB_APP_URL isn't set, `getOverdueCustomers` from WHATSAPP_SCRIPT_URL *must* return enough data.
                
                // Let's make `getOverdueCustomers` in the Apps Script return more data.
                // For now, we'll filter from a hypothetical 'allOrders' if available.
                
                // To make this truly work standalone, the Apps Script's `getOverdueCustomers` needs to return
                // the full order objects, not just sheetRows. I'll make a note in the Apps Script for this.
                
                // **Temporary Mock/Simplified Logic for this standalone page:**
                // Assume allOrders is available if we were integrated.
                // If not, we'd need a separate call to main SCRIPT_WEB_APP_URL or `getOverdueCustomers`
                // in WHATSAPP_SCRIPT_URL would need to return full order objects.
                
                // For now, if running truly standalone without the main script, allOrders would be empty.
                // Let's assume for this standalone test, we *can* call the main SCRIPT_WEB_APP_URL
                // to get basic order list needed for template generation if specific order is selected.
                
                const mainOrdersResponse = await fetch(`${SCRIPT_WEB_APP_URL}?action=list&status=all`); // Assuming main script is available
                if (mainOrdersResponse.ok) {
                    const mainOrdersData = await mainOrdersResponse.json();
                    if (mainOrdersData.success) {
                        allOrders = mainOrdersData.data.map(order => {
                            const orderDate = new Date(order['转专 ']);
                            const today = new Date();
                            const daysPassed = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                            order._daysPassedCalculated = daysPassed;

                            if (order['住住'] === '住专') {
                                order._effectiveStatus = '住专';
                            } else if (daysPassed >= OVERDUE_THRESHOLD_DAYS) {
                                order._effectiveStatus = '专';
                            } else {
                                order._effectiveStatus = '驻转';
                            }
                            order.sheetRow = parseInt(order.sheetRow);
                            return order;
                        });
                        console.log("All orders loaded from main script (for template context):", allOrders);
                    } else {
                         console.error("Failed to load all orders from main script:", mainOrdersData.message);
                    }
                } else {
                    console.error("Failed to fetch from main SCRIPT_WEB_APP_URL (status " + mainOrdersResponse.status + ")");
                }


                await fetchWhatsAppLogSummary(); // Load log summary for lightbulbs
                await loadWhatsAppTemplatesFromScript(); // Load templates
                renderAlertsTable(); // Render table of orders needing alerts
                startAutomatedAlertsTimer(); // Start timer
            } else {
                showAlert(response.message || '砖 注转 转 专转.', 'error');
            }
        }


        // --- WhatsApp Alerts Page Functions ---
        async function loadWhatsAppTemplatesFromScript() {
            if (!WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                showAlert("WHATSAPP_SCRIPT_URL  专.  转 注 转转 WhatsApp.", "error");
                return;
            }
            console.log("[loadWhatsAppTemplatesFromScript] Fetching templates from:", WHATSAPP_SCRIPT_URL); // DEBUG
            const response = await fetchData('getWhatsAppTemplates', {}, 0, WHATSAPP_SCRIPT_URL); // Using standalone fetchData
            if (response.success && response.data) {
                whatsappTemplates = response.data.map(t => ({
                    name: t['砖 转转'],
                    templateNameInScript: t['砖 转转'], 
                    category: t['拽专'],
                    messageContent: t['转 注'], 
                    linkUrl: t['拽砖专 URL'],
                    imageUrl: t['拽砖专 转']
                }));
                console.log("[loadWhatsAppTemplatesFromScript] Templates loaded:", whatsappTemplates); // DEBUG
                populateWhatsAppTemplates();
            } else {
                showAlert(response.message || '砖 注转 转转 WhatsApp 砖专转.', 'error');
                whatsappTemplates = [];
            }
        }

        function populateWhatsAppTemplates() {
            const select = document.getElementById('message-template-select');
            select.innerHTML = '<option value="">专 转转...</option>';
            if (whatsappTemplates.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = ' 转转 转';
                select.appendChild(option);
                console.warn("[populateWhatsAppTemplates] No templates available to populate."); // DEBUG
                return;
            }
            whatsappTemplates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = template.name; 
                option.textContent = template.name;
                select.appendChild(option);
            });
            console.log("[populateWhatsAppTemplates] Dropdown populated with templates."); // DEBUG
        }

        async function loadWhatsAppTemplate(sheetRow = null) {
            const select = document.getElementById('message-template-select');
            const messageInput = document.getElementById('whatsapp-message-input');
            const selectedTemplateName = select.value; 

            if (selectedTemplateName === "" || !WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                messageInput.value = "";
                if (!WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                    showAlert('转转 -URL 砖 住拽专驻 -WhatsApp  专转  砖.  转 注 转转.', 'error');
                }
                return;
            }

            const response = await fetchData(
                'generateMessage', 
                { templateName: selectedTemplateName, sheetRow: sheetRow || '' }, 
                0, 
                WHATSAPP_SCRIPT_URL // Use WHATSAPP_SCRIPT_URL explicitly
            );

            if (response.success) {
                messageInput.value = response.messageContent;
                document.getElementById('whatsapp-customer-name').value = response.customerName || '';
                document.getElementById('whatsapp-phone-number').value = response.phoneNumber || '';
                document.getElementById('details-order-id').textContent = response.orderDocId || '';
            } else {
                showAlert(response.message || '砖 注转 转 转转.', 'error');
                messageInput.value = "";
            }
        }

        function clearWhatsAppMessage() {
            document.getElementById('whatsapp-message-input').value = '';
            document.getElementById('message-template-select').value = '';
        }

        async function openWhatsAppAlertsForOrder(sheetRow) {
            const order = allOrders.find(o => o.sheetRow === sheetRow);
            if (!order) {
                showAlert('  爪.', 'error');
                return;
            }
            
            // In a full app, this would show the whatsapp-alerts-page. Here it's already the page.
            document.getElementById('whatsapp-customer-name').value = order['砖 拽'] || '';
            document.getElementById('whatsapp-phone-number').value = order['驻 拽'] || '';
            document.getElementById('whatsapp-address').value = order['转转'] || '';
            document.getElementById('details-order-id').textContent = order['转注'] || '';

            let templateNameInScript = '';
            if (order._effectiveStatus === '专') {
                templateNameInScript = '专 - 转专转'; 
            } else if (order._daysPassedCalculated >= (OVERDUE_THRESHOLD_DAYS - 2) && order._effectiveStatus === '驻转') { 
                templateNameInScript = '驻 专 - 专'; 
            } else {
                templateNameInScript = '注 转'; 
            }
            
            const selectedTemplate = whatsappTemplates.find(t => t.name === templateNameInScript); 
            if (selectedTemplate) {
                document.getElementById('message-template-select').value = selectedTemplate.name; 
            } else {
                document.getElementById('message-template-select').value = '';
            }
            
            await loadWhatsAppTemplate(sheetRow); 
        }

        async function renderAlertsTable() {
            const alertsTableBody = document.getElementById('alerts-table-body');
            alertsTableBody.innerHTML = '';
            document.getElementById('no-alerts-needed').classList.add('hidden');

            if (!WHATSAPP_SCRIPT_URL || WHATSAPP_SCRIPT_URL.includes('YOUR_NEW_WHATSAPP_SCRIPT_WEB_APP_URL_HERE')) {
                showAlert("WHATSAPP_SCRIPT_URL  专.  转 注 转专转 WhatsApp.", "error");
                return;
            }
            // Use the main SCRIPT_WEB_APP_URL to get all orders, then filter locally
            // This is a simplification for a standalone page; in the full app, getOverdueCustomers is in WHATSAPP_SCRIPT_URL.
            const allOrdersResponse = await fetch(`${SCRIPT_WEB_APP_URL}?action=list&status=all`); // Fetch ALL orders from main script
            let ordersNeedingAlert = [];

            if (allOrdersResponse.ok) {
                const allOrdersData = await allOrdersResponse.json();
                if (allOrdersData.success) {
                    allOrders = allOrdersData.data.map(order => {
                        const orderDate = new Date(order['转专 ']);
                        const today = new Date();
                        const daysPassed = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                        order._daysPassedCalculated = daysPassed;
                        order._effectiveStatus = (order['住住'] === '住专') ? '住专' : (daysPassed >= OVERDUE_THRESHOLD_DAYS ? '专' : '驻转');
                        order.sheetRow = parseInt(order.sheetRow);
                        return order;
                    });
                    
                    ordersNeedingAlert = allOrders.filter(order => 
                        (order._effectiveStatus === '专' || 
                        (order._effectiveStatus === '驻转' && order._daysPassedCalculated >= (OVERDUE_THRESHOLD_DAYS - 2))) 
                        && order['驻 拽']
                    );
                    console.log("Orders needing alerts:", ordersNeedingAlert);

                    if (ordersNeedingAlert.length === 0) {
                        document.getElementById('no-alerts-needed').classList.remove('hidden');
                    } else {
                        ordersNeedingAlert.forEach(order => {
                            const row = alertsTableBody.insertRow();
                            row.className = 'border-b border-[var(--color-border)]';
                            
                            const whatsappStatusIndicator = getWhatsAppStatusHtml(order['转注'], order['驻 拽']);

                            row.innerHTML = `
                                <td class="p-3 font-medium">${order['转注'] || ''}</td>
                                <td class="p-3">${order['砖 拽'] || ''}</td>
                                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                                <td class="p-3">${order._daysPassedCalculated || ''}</td>
                                <td class="p-3 flex items-center gap-2">
                                    ${whatsappStatusIndicator}
                                    <button class="btn btn-primary btn-sm" onclick="openWhatsAppAlertsForOrder(${order.sheetRow})">
                                        <i class="fab fa-whatsapp"></i> 砖 注
                                    </button>
                                </td>
                            `;
                        });
                    }
                } else {
                    showAlert(allOrdersData.message || '砖 砖驻转 转 转 转专转.', 'error');
                }
            } else {
                showAlert('砖 转拽砖专转 注 砖专转 专砖 (Main SCRIPT_WEB_APP_URL).', 'error');
            }
        }

        async function sendAllOverdueAlertsManually() {
            showAlert('驻转 注转 WhatsApp 注专  拽转 专.  注砖 驻转 住驻专 专 砖 转/专住转.', 'warning', 10000);
            const overdueOrders = allOrders.filter(order => order._effectiveStatus === '专' && order['驻 拽']);

            if (overdueOrders.length === 0) {
                showAlert(' 拽转 专 砖  转专转.', 'info');
                return;
            }

            for (const order of overdueOrders) {
                const messageResponse = await fetchData(
                    'generateMessage', 
                    { templateName: '专 - 转专转', sheetRow: order.sheetRow }, 
                    0, 
                    WHATSAPP_SCRIPT_URL
                );

                if (messageResponse.success) {
                    const whatsappUrl = `https://wa.me/${order['驻 拽']}?text=${encodeURIComponent(messageResponse.messageContent)}`;
                    window.open(whatsappUrl, '_blank');
                    await logWhatsAppMessage(
                        order['转注'], 
                        order['砖 拽'], 
                        order['驻 拽'], 
                        messageResponse.messageContent, 
                        messageResponse.messageType, 
                        '砖 转 (驻转 )', 
                        ''
                    );
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    showAlert(`砖 转 注 ${order['砖 拽']}: ${messageResponse.message}`, 'error');
                }
            }
            showAlert('砖 驻转转 注转 WhatsApp 注专  拽转 专.', 'success');
        }


        // --- Utility function for formatting date (copied from main script) ---
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date.getTime())) return dateInput;
            return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }


        // --- Automated Alerts Timer and Display ---
        function startAutomatedAlertsTimer() {
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
            }
            const timerDisplay = document.getElementById('automated-alerts-timer');
            const timerContainer = document.getElementById('automated-alerts-status-container');
            const updateTimer = () => {
                const now = new Date();
                const nextTrigger = new Date(now);
                nextTrigger.setHours(AUTOMATED_TRIGGER_HOUR, AUTOMATED_TRIGGER_MINUTE, 0, 0);

                if (now.getHours() > AUTOMATED_TRIGGER_HOUR || (now.getHours() === AUTOMATED_TRIGGER_HOUR && now.getMinutes() >= AUTOMATED_TRIGGER_MINUTE)) {
                    nextTrigger.setDate(nextTrigger.getDate() + 1);
                }

                const timeLeftMs = nextTrigger.getTime() - now.getTime();
                const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeftMs % (1000 * 60)) / 1000);

                const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerDisplay.textContent = formattedTime;

                if (now.getHours() < AUTOMATED_TRIGGER_HOUR || (now.getHours() === AUTOMATED_TRIGGER_HOUR && now.getMinutes() < AUTOMATED_TRIGGER_MINUTE)) {
                    timerContainer.classList.remove('bg-green-100', 'animate-pulse-green');
                    timerContainer.classList.add('bg-red-100', 'text-red-700', 'animate-pulse-red');
                    timerContainer.innerHTML = `<i class="fas fa-hourglass-half ml-2"></i> 转专转 转 砖 注: <span id="automated-alerts-timer" class="font-bold text-red-700">${formattedTime}</span>`;
                } else {
                    timerContainer.classList.remove('bg-red-100', 'animate-pulse-red');
                    timerContainer.classList.add('bg-green-100', 'text-green-700', 'animate-pulse-green');
                    timerContainer.innerHTML = `<i class="fas fa-check-circle ml-2"></i> 转专转 转 砖 . <span id="automated-alerts-timer" class="font-bold text-green-700">${formattedTime}</span>  注 砖 : `;
                }
            };
            updateTimer();
            timerIntervalId = setInterval(updateTimer, 1000);
        }


        // Initial load and setup
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTheme();
            // Attach event listener for the "Send All Overdue Alerts" button
            document.getElementById('send-all-overdue-alerts-btn').addEventListener('click', sendAllOverdueAlertsManually);
            await loadOrders(); // Load relevant data for this page
        });
    </script>
</body>
</html>
